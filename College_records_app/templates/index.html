<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- jQuery + Validation -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/jquery.validation/1.16.0/jquery.validate.min.js"></script>
  <script src="https://cdn.jsdelivr.net/jquery.validation/1.16.0/additional-methods.min.js"></script>

  <!-- DataTables -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

  <title>College Records</title>

  <style>
    /* Validator error messages */
    label.error {
      color: #dc3545;
      font-size: 0.9rem;
    }

    body {
      background: #f8f9fa;
      font-family: "Segoe UI", Roboto, sans-serif;
      caret-color: transparent;
    }

    .modal-body {
      caret-color: auto;
    }

    /* Modern header */
    .header-container {
      margin-top: 2rem;
    }

    .header-banner {
      background: linear-gradient(135deg, #0d6efd, #198754);
      color: white;
      border-radius: 1rem;
      padding: 2.5rem 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* Table styling */
    .table-container {
      background: white;
      border-radius: 1rem;
      padding: 1rem;
      margin-top: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    table.dataTable thead {
      background: #0d6efd;
      color: white;
    }

    /* Action buttons */
    .action-icons a {
      color: #0d6efd;
      transition: 0.3s ease;
    }

    .action-icons a:hover {
      color: #198754;
    }

    /* Modal styling */
    .modal-content {
      border-radius: 1rem;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
    }

    .modal-header {
      background: #0d6efd;
      color: white;
      border-top-left-radius: 1rem;
      border-top-right-radius: 1rem;
    }

    .btn-primary {
      background: #0d6efd;
      border: none;
    }

    .btn-primary:hover {
      background: #0b5ed7;
    }

    .btn-success {
      background: #198754;
      border: none;
    }

    .btn-success:hover {
      background: #157347;
    }

    .table {
      table-layout: fixed;
      width: 100%;
    }

    /* Prevent breaking UI */
    .table td,
    .table th {
      max-width: 190px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Show full text on hover */
    .table td:hover {
      white-space: normal;
      overflow: visible;
      background: #f9f9f9;
      z-index: 2;
      position: relative;
    }
  </style>
</head>

<body>
  <!-- College Records -->
  <div class="container-fluid">
    <div class="row">
      <div class="col-lg-12 mx-auto">
        <div class="header-container text-center">
          <div class="header-banner">
            <h1 class="fw-bold">College Records</h1>
            <p>Any Placeholder text here </p>
            <button type="button" class="btn btn-success btn-lg shadow-sm" id="AddRecordButton" data-bs-toggle="modal"
              data-bs-target="#RecordsModal">
              <i class="bi bi-plus-lg"></i> Add Record
            </button>
          </div>
        </div>

        <div class="table-container">
          <table class="table table-hover table-striped align-middle" id="records_table">
            <thead>
              <tr>
                <th>College Code</th>
                <th>College Name</th>
                <th>Address</th>
                <th>Country</th>
                <th>State</th>
                <th>District</th>
                <th>Taluka</th>
                <th>City</th>
                <th>College Type</th>
                <th>Belongs To</th>
                <th>Affiliated To</th>
                <th>Discipline</th>
                <th class="text-center">Action</th>
              </tr>
            </thead>
          </table>

        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div class="modal fade" id="RecordsModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5">Add Record</h1>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form method="post" id="add_edit_form" class="row g-3">
            {% csrf_token %}
            <input type="hidden" name="id" id="record_id" value="0">

            <!-- College Code -->
            <div class="col-md-6">
              <label for="college_code" class="form-label">College Code</label>
              <input type="text" class="form-control" id="college_code" name="college_code" pattern="[A-Za-z0-9]+"
                required>
            </div>

            <!-- College Name -->
            <div class="col-md-6">
              <label for="college_name" class="form-label">College Name</label>
              <input type="text" class="form-control" id="college_name" name="college_name" required>
            </div>

            <!-- Address -->
            <div class="col-12">
              <label for="address" class="form-label">Address</label>
              <textarea class="form-control" id="address" name="address" rows="3"
                placeholder="Enter full address"></textarea>
            </div>

            <!-- Country -->
            <div class="col-md-4">
              <label for="country" class="form-label">Country</label>
              <select class="form-select" id="country" name="country" required>
                <option value="India" selected>India</option>
              </select>
            </div>

            <!-- State -->
            <div class="col-md-4">
              <label for="state" class="form-label">State</label>
              <select class="form-select" id="state" name="state" required>
                <option value="Maharashtra" selected>Maharashtra</option>
              </select>
            </div>

            <!-- District -->
            <div class="col-md-4">
              <label for="district" class="form-label">District</label>
              <select class="form-select" id="district" name="district" required>
                <option value="">Select District</option>
                <option value="nagpur">Nagpur</option>
              </select>
            </div>

            <!-- Taluka -->
            <div class="col-md-6">
              <label for="taluka" class="form-label">Taluka</label>
              <select class="form-select" id="taluka" name="taluka" required>
                <option value="">Select Taluka</option>
                <option value="nagpur">Nagpur</option>
              </select>
            </div>

            <!-- City -->
            <div class="col-md-6">
              <label for="city" class="form-label">City</label>
              <select class="form-select" id="city" name="city" required>
                <option value="">Select City</option>
                <option value="nagpur">Nagpur</option>
              </select>
            </div>

            <!-- College Type -->
            <div class="col-md-6">
              <label for="college_type" class="form-label">College Type</label>
              <select class="form-select" id="college_type" name="college_type" required>
                <option value="">Select Type</option>
                <option value="Government">Government</option>
                <option value="Private">Private</option>
                <option value="Semi Government">Semi Government</option>
              </select>
            </div>

            <!-- Belongs To -->
            <div class="col-md-6">
              <label for="belongs_to" class="form-label">Belongs To</label>
              <select class="form-select" id="belongs_to" name="belongs_to">
                <option value="">Select Option</option>
                <option value="Minority">Minority</option>
                <option value="Ladies">Ladies</option>
                <option value="person_with_disability">Person with disability</option>
              </select>
            </div>

            <!-- Affiliated To -->
            <div class="col-md-6">
              <label for="affiliated_to" class="form-label">Affiliated To</label>
              <select class="form-select" id="affiliated_to" name="affiliated_to">
                <option value="">Select University/Board</option>
                <option value="RTMNU">RTMNU</option>
              </select>
            </div>

            <!-- Discipline -->
            <div class="col-md-6">
              <label for="discipline" class="form-label">Discipline</label>

              <div class="dropdown">
                <!-- button styled like form-select; uses bootstrap dropdown for the menu -->
                <button class="form-select dropdown-toggle text-start" type="button" id="disciplineDropdown"
                  data-bs-toggle="dropdown" aria-expanded="false">
                  Select Discipline(s)
                </button>

                <div class="dropdown-menu w-100 p-2" aria-labelledby="disciplineDropdown"
                  style="max-height:240px; overflow:auto;">
                  <div class="form-check">
                    <input class="form-check-input discipline-checkbox" type="checkbox" value="Engineering"
                      id="discipline_engineering" name="discipline[]">
                    <label class="form-check-label" for="discipline_engineering">Engineering College</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input discipline-checkbox" type="checkbox" value="Medical"
                      id="discipline_medical" name="discipline[]">
                    <label class="form-check-label" for="discipline_medical">Medical College</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input discipline-checkbox" type="checkbox" value="Law" id="discipline_law"
                      name="discipline[]">
                    <label class="form-check-label" for="discipline_law">Law College</label>
                  </div>
                </div>
              </div>
            </div>


            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-primary" id="submit_button">Add</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

</body>

<script>
  $('document').ready(function () {
    // Loading college records details when edit button is clicked
    $('#RecordsModal').on('show.bs.modal', function (e) {
      var $modal = $(this)
      var record_id = $(e.relatedTarget).data('record-id')

      if (record_id > 0) {
        $modal.find('.modal-title').text('Edit Record')
        $modal.find('#submit_button').text('Edit')
        $modal.find('#record_id').val(record_id)
        console.log(record_id)

        var rowdata = $('table#records_table').DataTable().row('table#records_table tbody tr#' + record_id).data()
        var rowdata2 = $('table#records_table').DataTable().row('table#records_table tbody tr#' + record_id)
        console.log(rowdata2)

        // populate modal form fields in order to edit 
        $modal.find('#college_code').val(rowdata[0])
        $modal.find('#college_name').val(rowdata[1])
        $modal.find('#address').val(rowdata[2])
        $modal.find('#country').val(rowdata[3])
        $modal.find('#state').val(rowdata[4])
        $modal.find('#district').val(rowdata[5])
        $modal.find('#city').val(rowdata[6])
        $modal.find('#taluka').val(rowdata[7])
        $modal.find('#college_type').val(rowdata[8])
        $modal.find('#belongs_to').val(rowdata[9])
        $modal.find('#affiliated_to').val(rowdata[10])

        // Discipline (multi-select dropdown)
        var disciplines = rowdata[11]
          ? rowdata[11].split(',').map(d => d.trim())
          : []

        // First uncheck all
        $modal.find('.discipline-checkbox').prop('unchecked', false)
        // Then check the ones that match
        disciplines.forEach(function(val) {
          $modal.find('.discipline-checkbox[value="'+ val +'"]').prop('checked',true);
        });

      }
    }).on('hidden.bs.modal', function () {
      var $modal = $(this)
      $modal.find('.modal-title').text('Add Record')
      $modal.find('#submit_button').text('Add')
      $modal.find('#record_id').val(0)
      $('#add_edit_form')[0].reset()
      $('#add_edit_form').validate().resetForm()
      $modal.find('.discipline-checkbox').prop('checked', false);

    })

    // Validating all the input fields
    $('#add_edit_form').validate({
      rules: {
        college_name: {
          required: true,
          minlength: 2
        }
      },
      messages: {
        college_name: {
          required: "Please enter the college name",
          minlength: "College name must consist of at least 2 characters"
        }
      },
      submitHandler: function (form) {
        add_edit_records();
      }
    })

    // DataTable 
    $('#records_table').DataTable({
      paging: true,
      searching: true,
      responsive: true,
      processing: true,
      serverSide: true,
      scrollY: 360,
      pageLength: 15,

      lengthMenu: [[5, 10, 15, 20], ["5", "10", "15", "20"]],

      ajax: {
        url: '{% url "get_records" %}',
        type: 'GET'
      },
      // this part acts as a success to ajax 
      columns: [
        { data: 0 },  // College Code
        { data: 1 },  // College Name
        { data: 2 },  // Address
        { data: 3 },  // Country
        { data: 4 },  // State
        { data: 5 },  // District
        { data: 6 },  // Taluka
        { data: 7 },  // City
        { data: 8 },  // College Type
        { data: 9 },  // Belongs To
        { data: 10 }, // Affiliated To
        { data: 11 }, // Discipline
        { data: null, searchable: false, orderable: false } // Action
      ],


      // adding the edit and delete button to the row and setting arrtibute to each tr 
      // The createdRow option is a callback function that allows you to modify the row after it has been created but before it is displayed on the page 
      createdRow: function (row, data, dataIndex) {
        $(row).attr('id', data[12])
        console.log(data[12])
        $('td:eq(12)', row).html(` <div class="d-flex justify-content-center align-items-center gap-2">
        <a class="btn btn-sm btn-outline-primary" 
           href="#" 
           data-bs-toggle="modal" 
           data-record-id="${data[12]}" 
           data-bs-target="#RecordsModal"
           data-bs-toggle="tooltip" 
           title="Edit">
           <i class="bi bi-pencil-square"></i>
        </a>
        <a class="btn btn-sm btn-outline-danger" 
           href="#" 
           onclick="delete_record('${data[12]}')"
           data-bs-toggle="tooltip" 
           title="Delete">
           <i class="bi bi-trash"></i>
        </a>
    </div>`)
      }
    });
  })

  // Function to add or edit a contact based on the status code returned
  function add_edit_records() {
    $.ajax({
      url: '{% url "add_edit_record" %}',
      type: 'POST',
      data: $('#add_edit_form').serialize(),
      success: function (data, status, xhr) {
        // when add button is clicked the id will be 0 hence the status returned will be 201

        if (data.status === 201) {
          $('table#records_table').DataTable().draw()

          // alert(data.message)
        }

        // when the edit button is clicked the id will be a non zero value hence status code 200 will be returned indicating that an existing record is overwritten

        else if (data.status === 200) {
          $('table#records_table').DataTable().draw()
        }
        // hide the modal automatically after the use is fulfilled
        $('#RecordsModal').modal('hide')
      },

      error: function (xhr, status, error) {
        alert('Error  occured' + error)
      }
    })
  }

  // this function is called by the delete anchor itself with the contact id as a parameter, it sends the id and csrf middleware token and a status code 204 is generated when the contact corresponding to the id is deleted, then the ajax removes it from the front end
  function delete_record(id) {
    if (confirm("Are you sure you want to delete this contact?")) {
      $.ajax({
        type: 'POST',
        url: '{% url "delete_record" %}',
        data: {
          'id': id,
          'csrfmiddlewaretoken': $('[name = "csrfmiddlewaretoken"]').val()
        },
        success: function (data, status, xhr) {
          if (data.status === 204) {
            $('table#records_table').DataTable().draw()
          }
          else {
            alert(data.message)
          }
        }
      })
    }
  }


</script>

</html>