<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- jQuery + Validation -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/jquery.validation/1.16.0/jquery.validate.min.js"></script>
  <script src="https://cdn.jsdelivr.net/jquery.validation/1.16.0/additional-methods.min.js"></script>

  <!-- DataTables -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

  <!-- Buttons CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">

  <!-- Buttons + dependencies for excel and print button -->
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>


  <title>Student Records</title>

  <style>
    /* =========================================================
     GLOBAL / BODY
  ========================================================= */
    /* Validation */
    label.error {
      color: #dc3545;
      font-size: 0.9rem;
    }

    body {
      background: #f8f9fa;
      font-family: "Segoe UI", Roboto, sans-serif;
      caret-color: transparent;
      margin: 0;
      padding: 0;
      height: 100%;
      overflow-x: hidden;
      overflow-y: auto;
      /* IMPORTANT */
    }

    /* =========================================================
     MODAL SCROLL / SIZING
  ========================================================= */
    .modal-dialog {
      max-width: 90%;
      margin: 1.5rem auto;
    }

    .modal-content {
      max-height: 95vh;
      overflow: hidden;
    }

    .modal-body {
      caret-color: auto;
      overflow-y: auto;
      max-height: calc(95vh - 120px);
      /* Fix overflow */
      padding-right: 15px;
    }

    /* =========================================================
     HEADER BANNER (TOP OF PAGE)
  ========================================================= */
    .header-container {
      margin-top: 0.5rem;
    }

    .header-banner {
      background: linear-gradient(135deg, #0d6efd, #198754);
      color: white;
      border-radius: 1rem;
      padding: 2.5rem 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      position: relative;
      /* for header-actions positioning */
    }

    /* Right-side header actions (Create / Logout / Export / Year) */
    .header-banner .header-actions {
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.5rem;
      z-index: 5;
      padding: 0.25rem;
    }

    .header-banner .header-actions .btn-row,
    .header-banner .header-actions .bottom-row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      justify-content: flex-end;
    }

    .header-banner .header-actions select#globalAcademicYear {
      width: 110px;
      max-width: 100%;
    }

    /* Responsive header actions */
    @media (max-width: 720px) {
      .header-banner .header-actions {
        position: static;
        transform: none;
        margin-top: 0.75rem;
        align-items: center;
        right: auto;
        top: auto;
        flex-direction: row;
        gap: 0.5rem;
      }

      .header-banner .header-actions .bottom-row {
        flex-direction: row;
        gap: 0.5rem;
      }
    }

    /* =========================================================
     TABLE CONTAINER / DATATABLE HEADER
  ========================================================= */
    .table-container {
      background: white;
      border-radius: 1rem;
      padding: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    table.dataTable thead {
      background: #0d6efd;
      color: white;
    }

    table.dataTable thead th {
      text-align: left;
      vertical-align: middle;
    }

    /* =========================================================
     NOTIFICATIONS
  ========================================================= */
    .notification {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px 30px;
      font-size: 1rem;
      font-weight: bold;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      opacity: 0;
      transition: opacity 0.5s ease-out, transform 0.5s ease-out;
      z-index: 2000;
    }

    .notification-success {
      background-color: #28a745;
      color: white;
    }

    .notification-error {
      background-color: #dc3545;
      color: white;
    }

    .show-notification {
      opacity: 1;
      transform: translateX(-50%) translateY(20px);
    }

    /* =========================================================
     COLLEGE CODE CASSETTE
  ========================================================= */
    #collegeCodeCassette {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-top: 1rem;
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transition: max-height 0.35s ease, opacity 0.3s ease;
    }

    #collegeCodeCassette .inner-cassette {
      background: white;
      padding: 0.6rem 0.9rem;
      border-radius: 0.75rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      border: 1px solid rgba(0, 0, 0, 0.08);
      width: auto;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    #collegeCodeCassette.show {
      max-height: 90px;
      opacity: 1;
    }

    #collegeCodeInput {
      text-align: center;
      background: #f8f9fa;
      border: 1px solid rgba(0, 0, 0, 0.1);
      width: 140px;
    }

    #collegeCodeInput:focus {
      background: #fff;
      border-color: #0d6efd;
      box-shadow: 0 0 0 0.15rem rgba(13, 110, 253, 0.15);
    }

    /* =========================================================
     DATATABLE CHILD / ACCORDION WIDTH FIXES
  ========================================================= */
    /* kill extra side margins in DataTables child rows */
    .dt-child-scroll .row {
      margin-left: 0 !important;
      margin-right: 0 !important;
    }

    /* Ensure accordion inside DataTable row uses full width */
    .dt-child-scroll .accordion-item,
    .dt-child-scroll .accordion-button,
    .dt-child-scroll .accordion-body,
    .dt-child-scroll .container-fluid,
    .dt-child-scroll .row {
      width: 100% !important;
      max-width: 100% !important;
      overflow-x: hidden;
    }

    /* =========================================================
     DISCIPLINE HEADER (IN CHILD ACCORDION)
  ========================================================= */
    .discipline-header-row {
      display: flex;
      align-items: center;
      padding: 2px 4px;
      margin: 4px 0 2px 0;
      width: 100%;
    }

    .discipline-header-text {
      font-size: 1rem;
      font-weight: 600;
      color: #0d6efd;
      text-align: left;
      display: inline-block;
    }

    .discipline-divider {
      border-top: 1px solid #d7dce2;
      margin: 4px 0 10px 0;
    }

    .accordion .discipline-header-row,
    .accordion .discipline-header-text {
      padding-left: 0 !important;
      margin-left: 0 !important;
      text-align: left !important;
    }

    /* =========================================================
     PROGRAM CARDS LAYOUT (4 columns, full width)
     - Column 1: Gender + Washrooms stacked
     - Column 2: Category
     - Column 3: Religion
     - Column 4: Disability
  ========================================================= */
    .program-content-row {
      display: flex !important;
      flex-wrap: nowrap !important;
      /* keep 4 cards in one row */
      width: 100% !important;
      margin: 0 !important;
      padding-left: 0 !important;
      padding-right: 0 !important;
      --bs-gutter-x: 0;
      /* kill Bootstrap gutters */
    }

    .metric-col {
      flex: 0 0 25% !important;
      /* exactly 1/4 each */
      max-width: 25% !important;
      min-width: 0 !important;
      padding: 0 0.5rem !important;
      /* small internal gap */
      box-sizing: border-box !important;
    }

    .metric-col .card {
      width: 100%;
    }

    /* =========================================================
     PROGRAM EDIT MODAL (DISCIPLINE / PROGRAM BLOCKS)
  ========================================================= */
    .discipline-wrapper {
      background: #f1f5f9;
      border: 1px solid #d6dbe1;
      padding: 1rem 1.2rem;
      border-radius: 12px;
      margin-bottom: 2rem;
    }

    .discipline-title {
      font-size: 1.35rem !important;
      font-weight: 700 !important;
      color: #0d6efd !important;
    }

    .toggle-discipline i {
      font-size: 1.1rem;
    }

    .program-section {
      background: #ffffff;
      border: 1px solid #e3e6ea;
      border-radius: 10px;
      padding: 1rem 1.2rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      transition: box-shadow 0.2s ease;
    }

    .program-section:hover {
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    }

    .program-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: #198754;
      margin-bottom: 10px;
    }

    .program-section h6 {
      font-size: 1.1rem !important;
      font-weight: 700 !important;
      color: #333 !important;
      margin-top: 1.2rem !important;
      padding-bottom: 5px;
      border-bottom: 2px solid #dee2e6;
    }

    .program-section label.fw-semibold {
      font-size: 1.05rem;
      font-weight: 600 !important;
    }

    .program-section .row {
      margin-bottom: 0.6rem;
    }

    .program-section input {
      border-radius: 6px !important;
    }

    .discipline-programs-container .program-section:not(:last-child) {
      border-bottom: 2px dashed #d2d6da;
      padding-bottom: 1.2rem;
      margin-bottom: 1.5rem;
    }

    .discipline-programs-container {
      overflow: hidden;
    }

    .dt-child-scroll .accordion-button {
      font-weight: 600 !important;
      color: #1a1a1a !important;
      font-size: 1.02rem !important;
    }

    .dt-child-scroll .accordion-button:not(.collapsed) {
      background-color: #fafafa !important;
      color: #1a1a1a !important;
    }

    /* =========================================================
     MODAL HEADER – MATCH PAGE GRADIENT
  ========================================================= */
    #collegeModal .modal-header {
      background: linear-gradient(135deg, #0d6efd, #198754) !important;
      color: #fff !important;
      border-top-left-radius: 1rem !important;
      border-top-right-radius: 1rem !important;
      padding: 1.4rem 1.6rem !important;
    }

    #collegeModal .btn-close {
      filter: invert(1) brightness(200%) !important;
      opacity: 0.9;
    }

    #collegeModal .btn-close:hover {
      opacity: 1;
    }

    #modalCollegeName {
      color: #fff !important;
    }

    #modalCollegeAddress {
      color: rgba(255, 255, 255, 0.9) !important;
    }

    #collegeModal .modal-content {
      background: #ffffff;
      border-top-left-radius: 0 !important;
      border-top-right-radius: 0 !important;
      overflow: visible !important;
      /* allow header to round properly */
    }

    #collegeModal .modal-dialog {
      border-radius: 1rem !important;
      overflow: hidden;
      /* clips corners cleanly */
    }

    #collegeModal .modal-content {
      border-bottom-left-radius: 1rem !important;
      border-bottom-right-radius: 1rem !important;
    }

    .metric-body td.text-end {
      white-space: nowrap;
    }
    
  </style>

</head>

<body>
  <!-- Student Records -->
  <div class="container-fluid">
    <div class="row">
      <div class="col-lg-12 mx-auto">
        <div class="header-container text-center">
          <div class="header-banner position-relative">
            <!-- RIGHT SIDE — vertically centered actions (replace only the absolute block) -->
            <div class="header-actions">

              <!-- Welcome Text -->
              <span id="welcome_msg" class="text-light fw-semibold d-block mb-1">
                Welcome, {{ request.user.username }}
              </span>

              <!-- TOP ROW: Logout + Export -->
              <div class="btn-row">

                <!-- Logout (IDs/classes unchanged) -->
                <button id="logout_btn" class="btn btn-outline-light btn-sm logout-btn">
                  <i class="bi bi-box-arrow-right"></i> Logout
                </button>

                <!-- Export Excel (small button) -->
                <button type="button" class="btn btn-warning btn-sm shadow-sm" id="ExportStudentExcelButton">
                  <i class="bi bi-file-earmark-excel"></i>
                  Export to Excel
                </button>

              </div>

              <!-- BOTTOM ROW: Academic Year -->
              <div class="bottom-row">

                <div class="text-light small me-2 fw-semibold">Academic Year</div>

                <select id="globalAcademicYear" class="form-select form-select-sm">
                  {% for year in academic_year %}
                  <option value="{{ year.Academic_Year }}">{{ year.Academic_Year }}</option>
                  {% endfor %}
                </select>

              </div>

            </div>


            <h1 class="fw-bold">Student Records</h1>
            <p>Add your student record here</p>
            <button type="button" class="btn btn-success btn-lg shadow-sm" id="AddRecordButton">
              <i class="bi bi-plus-lg"></i> Add Record
            </button>

            <!-- Cascading Input Cassette -->
            <div id="collegeCodeCassette" class="cassette">
              <div class="inner-cassette d-flex align-items-center gap-2">
                <input type="text" id="collegeCodeInput" class="form-control form-control-sm" placeholder="College code"
                  inputmode="numeric">
                <button class="btn btn-primary btn-sm" id="submitCollegeCode">Submit</button>
              </div>
            </div>
          </div>

        </div>


        <div class="table-container" id="datatable_wrapper">
          <table id="records_table" class="table table-hover align-middle" width="100%">
            <thead>
              <tr>
                <th>Action</th>
                <th>College Code</th>
                <th>College Name</th>
                <th>Academic Year</th>
                <th>Total Students</th>
                <th>Edit/Delete</th>
              </tr>
            </thead>
          </table>

        </div>
      </div>
    </div>


    <!-- Add Student Records Modal -->
    <div class="modal fade" id="collegeModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">

          <div class="modal-header">
            <div>
              <h2 class="fw-bold mb-0" id="modalCollegeName"></h2>
              <small class="text-muted" id="modalCollegeAddress"></small>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">

            <!-- Academic Year -->
            <div class="col-md-4">
              <label class="fw-semibold">Academic Year</label>
              <select id="academicYear" class="form-select">
                <option value="">Select Year</option>
                {% for year in academic_year %}
                <option value="{{ year.Academic_Year }}">{{ year.Academic_Year }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Dynamic Program Sections Will Appear Here -->
            <div id="programSectionsContainer" class="mt-4"></div>

          </div>

          <div class="modal-footer">
            <button class="btn btn-success" id="submitRecordForm">Submit Records</button>
          </div>

        </div>
      </div>
    </div>

    <!-- DISCIPLINE WRAPPER TEMPLATE -->
    <template id="disciplineTemplate">
      <div class="discipline-wrapper mb-4 border rounded p-3 bg-light shadow-sm">

        <div class="d-flex align-items-center justify-content-between mb-2">
          <h3 class="fw-bold text-primary discipline-title mb-0"></h3>

          <button class="btn btn-sm btn-outline-secondary toggle-discipline">
            <i class="bi bi-chevron-down"></i>
          </button>
        </div>

        <!-- Holds ALL PROGRAM SECTIONS under this discipline -->
        <div class="discipline-programs-container mt-2"></div>

      </div>
    </template>

    <template id="programTemplate">
      <div class="program-section mb-4 p-3 border rounded shadow-sm bg-white">

        <h4 class="fw-bold text-dark program-title mb-3"></h4>

        <!-- TOTAL STUDENTS -->
        <h6 class="fw-bold text-secondary border-bottom pb-1">Total Students</h6>
        <div class="row mt-2">
          <div class="col-md-4">
            <input type="number" class="form-control total-students" placeholder="Enter total students" min="0">
          </div>
        </div>

        <!-- GENDER COUNT -->
        <h6 class="fw-bold text-secondary border-bottom pb-1 mt-4">Gender Count</h6>
        <div class="row mt-2">
          <div class="col-md-3">
            <label>Male</label>
            <input type="number" class="form-control gender-male" min="0" placeholder="M">
          </div>
          <div class="col-md-3">
            <label>Female</label>
            <input type="number
               " class="form-control gender-female" min="0" placeholder="F">
          </div>
          <div class="col-md-3">
            <label>Others</label>
            <input type="number" class="form-control gender-others" min="0" placeholder="O">
          </div>
        </div>

        <!-- WASHROOM COUNT -->
        <h6 class="fw-bold text-secondary border-bottom pb-1 mt-4">Washroom Count</h6>
        <div class="row mt-2">
          <div class="col-md-4">
            <label>Total Washrooms</label>
            <input type="number" class="form-control wash-total" min="0" placeholder="T">
          </div>
          <div class="col-md-4">
            <label>Male Washrooms</label>
            <input type="number" class="form-control wash-male" min="0" placeholder="M">
          </div>
          <div class="col-md-4">
            <label>Female Washrooms</label>
            <input type="number" class="form-control wash-female" min="0" placeholder="F">
          </div>
        </div>

        <!-- Immediately after total: quick per-subcategory gender breakdown header -->
        <div class="row mt-3">
          <div class="col-12">
            <small class="text-muted">
              For each subcategory below enter Male / Female / Others counts
            </small>
          </div>
        </div>

        <!-- ---------------------------
     CATEGORY COUNT (each subcategory now has 3 inputs: M / F / O)
     --------------------------- -->
        <h6 class="fw-bold text-secondary border-bottom pb-1 mt-4">Category Count</h6>

        <!-- OPEN -->
        <div class="row mt-2 align-items-end">
          <div class="col-md-3">
            <label class="form-label mb-1">Open (OPEN)</label>
          </div>
          <div class="col-md-3">
            <label class="small">Male</label>
            <input type="number" class="form-control cat-open-male" min="0" placeholder="M">
          </div>
          <div class="col-md-3">
            <label class="small">Female</label>
            <input type="number" class="form-control cat-open-female" min="0" placeholder="F">
          </div>
          <div class="col-md-3">
            <label class="small">Others</label>
            <input type="number" class="form-control cat-open-others" min="0" placeholder="O">
          </div>
        </div>

        <!-- OBC -->
        <div class="row mt-2 align-items-end">
          <div class="col-md-3">
            <label class="form-label mb-1">Other Backward Class (OBC)</label>
          </div>
          <div class="col-md-3">
            <label class="small">Male</label>
            <input type="number" class="form-control cat-obc-male" min="0" placeholder="M">
          </div>
          <div class="col-md-3">
            <label class="small">Female</label>
            <input type="number" class="form-control cat-obc-female" min="0" placeholder="F">
          </div>
          <div class="col-md-3">
            <label class="small">Others</label>
            <input type="number" class="form-control cat-obc-others" min="0" placeholder="O">
          </div>
        </div>

        <!-- SC -->
        <div class="row mt-2 align-items-end">
          <div class="col-md-3">
            <label class="form-label mb-1">Scheduled Caste (SC)</label>
          </div>
          <div class="col-md-3">
            <label class="small">Male</label>
            <input type="number" class="form-control cat-sc-male" min="0" placeholder="M">
          </div>
          <div class="col-md-3">
            <label class="small">Female</label>
            <input type="number" class="form-control cat-sc-female" min="0" placeholder="F">
          </div>
          <div class="col-md-3">
            <label class="small">Others</label>
            <input type="number" class="form-control cat-sc-others" min="0" placeholder="O">
          </div>
        </div>

        <!-- ST -->
        <div class="row mt-2 align-items-end">
          <div class="col-md-3">
            <label class="form-label mb-1">Scheduled Tribe (ST)</label>
          </div>
          <div class="col-md-3">
            <label class="small">Male</label>
            <input type="number" class="form-control cat-st-male" min="0" placeholder="M">
          </div>
          <div class="col-md-3">
            <label class="small">Female</label>
            <input type="number" class="form-control cat-st-female" min="0" placeholder="F">
          </div>
          <div class="col-md-3">
            <label class="small">Others</label>
            <input type="number" class="form-control cat-st-others" min="0" placeholder="O">
          </div>
        </div>

        <!-- NT -->
        <div class="row mt-2 align-items-end">
          <div class="col-md-3">
            <label class="form-label mb-1">Nomadic Tribe (NT)</label>
          </div>
          <div class="col-md-3">
            <label class="small">Male</label>
            <input type="number" class="form-control cat-nt-male" min="0" placeholder="M">
          </div>
          <div class="col-md-3">
            <label class="small">Female</label>
            <input type="number" class="form-control cat-nt-female" min="0" placeholder="F">
          </div>
          <div class="col-md-3">
            <label class="small">Others</label>
            <input type="number" class="form-control cat-nt-others" min="0" placeholder="O">
          </div>
        </div>

        <!-- VJNT -->
        <div class="row mt-2 align-items-end">
          <div class="col-md-3">
            <label class="form-label mb-1">VJNT (Vimukta Jati Nomadic Tribe)</label>
          </div>
          <div class="col-md-3">
            <label class="small">Male</label>
            <input type="number" class="form-control cat-vjnt-male" min="0" placeholder="M">
          </div>
          <div class="col-md-3">
            <label class="small">Female</label>
            <input type="number" class="form-control cat-vjnt-female" min="0" placeholder="F">
          </div>
          <div class="col-md-3">
            <label class="small">Others</label>
            <input type="number" class="form-control cat-vjnt-others" min="0" placeholder="O">
          </div>
        </div>

        <!-- EWS -->
        <div class="row mt-2 align-items-end">
          <div class="col-md-3">
            <label class="form-label mb-1">Economically Weaker Section (EWS)</label>
          </div>
          <div class="col-md-3">
            <label class="small">Male</label>
            <input type="number" class="form-control cat-ews-male" min="0" placeholder="M">
          </div>
          <div class="col-md-3">
            <label class="small">Female</label>
            <input type="number" class="form-control cat-ews-female" min="0" placeholder="F">
          </div>
          <div class="col-md-3">
            <label class="small">Others</label>
            <input type="number" class="form-control cat-ews-others" min="0" placeholder="O">
          </div>
        </div>

        <!-- ---------------------------
     RELIGION COUNT (same pattern)
     --------------------------- -->
        <h6 class="fw-bold text-secondary border-bottom pb-1 mt-4">Religion Count</h6>

        <!-- Hindu -->
        <div class="row mt-2 align-items-end">
          <div class="col-md-3"><label class="form-label mb-1">Hindu</label></div>
          <div class="col-md-3">
            <label class="small">Male</label>
            <input type="number" class="form-control rel-hindu-male" min="0" placeholder="M">
          </div>
          <div class="col-md-3">
            <label class="small">Female</label>
            <input type="number" class="form-control rel-hindu-female" min="0" placeholder="F">
          </div>
          <div class="col-md-3">
            <label class="small">Others</label>
            <input type="number" class="form-control rel-hindu-others" min="0" placeholder="O">
          </div>
        </div>

        <!-- Muslim -->
        <div class="row mt-2 align-items-end">
          <div class="col-md-3"><label class="form-label mb-1">Muslim</label></div>
          <div class="col-md-3">
            <label class="small">Male</label>
            <input type="number" class="form-control rel-muslim-male" min="0" placeholder="M">
          </div>
          <div class="col-md-3">
            <label class="small">Female</label>
            <input type="number" class="form-control rel-muslim-female" min="0" placeholder="F">
          </div>
          <div class="col-md-3">
            <label class="small">Others</label>
            <input type="number" class="form-control rel-muslim-others" min="0" placeholder="O">
          </div>
        </div>

        <!-- Sikh -->
        <div class="row mt-2 align-items-end">
          <div class="col-md-3"><label class="form-label mb-1">Sikh</label></div>
          <div class="col-md-3">
            <label class="small">Male</label>
            <input type="number" class="form-control rel-sikh-male" min="0" placeholder="M">
          </div>
          <div class="col-md-3">
            <label class="small">Female</label>
            <input type="number" class="form-control rel-sikh-female" min="0" placeholder="F">
          </div>
          <div class="col-md-3">
            <label class="small">Others</label>
            <input type="number" class="form-control rel-sikh-others" min="0" placeholder="O">
          </div>
        </div>

        <!-- Christian -->
        <div class="row mt-2 align-items-end">
          <div class="col-md-3"><label class="form-label mb-1">Christian</label></div>
          <div class="col-md-3">
            <label class="small">Male</label>
            <input type="number" class="form-control rel-christian-male" min="0" placeholder="M">
          </div>
          <div class="col-md-3">
            <label class="small">Female</label>
            <input type="number" class="form-control rel-christian-female" min="0" placeholder="F">
          </div>
          <div class="col-md-3">
            <label class="small">Others</label>
            <input type="number" class="form-control rel-christian-others" min="0" placeholder="O">
          </div>
        </div>

        <!-- Jain -->
        <div class="row mt-2 align-items-end">
          <div class="col-md-3"><label class="form-label mb-1">Jain</label></div>
          <div class="col-md-3">
            <label class="small">Male</label>
            <input type="number" class="form-control rel-jain-male" min="0" placeholder="M">
          </div>
          <div class="col-md-3">
            <label class="small">Female</label>
            <input type="number" class="form-control rel-jain-female" min="0" placeholder="F">
          </div>
          <div class="col-md-3">
            <label class="small">Others</label>
            <input type="number" class="form-control rel-jain-others" min="0" placeholder="O">
          </div>
        </div>

        <!-- Buddhist -->
        <div class="row mt-2 align-items-end">
          <div class="col-md-3"><label class="form-label mb-1">Buddhist</label></div>
          <div class="col-md-3">
            <label class="small">Male</label>
            <input type="number" class="form-control rel-buddhist-male" min="0" placeholder="M">
          </div>
          <div class="col-md-3">
            <label class="small">Female</label>
            <input type="number" class="form-control rel-buddhist-female" min="0" placeholder="F">
          </div>
          <div class="col-md-3">
            <label class="small">Others</label>
            <input type="number" class="form-control rel-buddhist-others" min="0" placeholder="O">
          </div>
        </div>

        <!-- Other Religions -->
        <div class="row mt-2 align-items-end">
          <div class="col-md-3"><label class="form-label mb-1">Other Religions</label></div>
          <div class="col-md-3">
            <label class="small">Male</label>
            <input type="number" class="form-control rel-other_religion-male" min="0" placeholder="M">
          </div>
          <div class="col-md-3">
            <label class="small">Female</label>
            <input type="number" class="form-control rel-other_religion-female" min="0" placeholder="F">
          </div>
          <div class="col-md-3">
            <label class="small">Others</label>
            <input type="number" class="form-control rel-other_religion-others" min="0" placeholder="O">
          </div>
        </div>

        <!-- ---------------------------
     DISABILITY COUNT (same pattern)
     --------------------------- -->
        <h6 class="fw-bold text-secondary border-bottom pb-1 mt-4">Disability Count</h6>

        <!-- No Disability -->
        <div class="row mt-2 align-items-end">
          <div class="col-md-3"><label class="form-label mb-1">No Disability</label></div>
          <div class="col-md-3">
            <label class="small">Male</label>
            <input type="number" class="form-control dis-no_disability-male" min="0" placeholder="M">
          </div>
          <div class="col-md-3">
            <label class="small">Female</label>
            <input type="number" class="form-control dis-no_disability-female" min="0" placeholder="F">
          </div>
          <div class="col-md-3">
            <label class="small">Others</label>
            <input type="number" class="form-control dis-no_disability-others" min="0" placeholder="O">
          </div>
        </div>

        <!-- Low Vision -->
        <div class="row mt-2 align-items-end">
          <div class="col-md-3"><label class="form-label mb-1">Low Vision</label></div>
          <div class="col-md-3">
            <label class="small">Male</label>
            <input type="number" class="form-control dis-lowvision-male" min="0" placeholder="M">
          </div>
          <div class="col-md-3">
            <label class="small">Female</label>
            <input type="number" class="form-control dis-lowvision-female" min="0" placeholder="F">
          </div>
          <div class="col-md-3">
            <label class="small">Others</label>
            <input type="number" class="form-control dis-lowvision-others" min="0" placeholder="O">
          </div>
        </div>

        <!-- Blindness -->
        <div class="row mt-2 align-items-end">
          <div class="col-md-3"><label class="form-label mb-1">Blindness</label></div>
          <div class="col-md-3">
            <label class="small">Male</label>
            <input type="number" class="form-control dis-blindness-male" min="0" placeholder="M">
          </div>
          <div class="col-md-3">
            <label class="small">Female</label>
            <input type="number" class="form-control dis-blindness-female" min="0" placeholder="F">
          </div>
          <div class="col-md-3">
            <label class="small">Others</label>
            <input type="number" class="form-control dis-blindness-others" min="0" placeholder="O">
          </div>
        </div>

        <!-- Hearing Impaired -->
        <div class="row mt-2 align-items-end">
          <div class="col-md-3"><label class="form-label mb-1">Hearing Impaired</label></div>
          <div class="col-md-3">
            <label class="small">Male</label>
            <input type="number" class="form-control dis-hearing-male" min="0" placeholder="M">
          </div>
          <div class="col-md-3">
            <label class="small">Female</label>
            <input type="number" class="form-control dis-hearing-female" min="0" placeholder="F">
          </div>
          <div class="col-md-3">
            <label class="small">Others</label>
            <input type="number" class="form-control dis-hearing-others" min="0" placeholder="O">
          </div>
        </div>

        <!-- Locomotor Disability -->
        <div class="row mt-2 align-items-end">
          <div class="col-md-3"><label class="form-label mb-1">Locomotor Disability</label></div>
          <div class="col-md-3">
            <label class="small">Male</label>
            <input type="number" class="form-control dis-locomotor-male" min="0" placeholder="M">
          </div>
          <div class="col-md-3">
            <label class="small">Female</label>
            <input type="number" class="form-control dis-locomotor-female" min="0" placeholder="F">
          </div>
          <div class="col-md-3">
            <label class="small">Others</label>
            <input type="number" class="form-control dis-locomotor-others" min="0" placeholder="O">
          </div>
        </div>

        <!-- Autism -->
        <div class="row mt-2 align-items-end">
          <div class="col-md-3"><label class="form-label mb-1">Autism</label></div>
          <div class="col-md-3">
            <label class="small">Male</label>
            <input type="number" class="form-control dis-autism-male" min="0" placeholder="M">
          </div>
          <div class="col-md-3">
            <label class="small">Female</label>
            <input type="number" class="form-control dis-autism-female" min="0" placeholder="F">
          </div>
          <div class="col-md-3">
            <label class="small">Others</label>
            <input type="number" class="form-control dis-autism-others" min="0" placeholder="O">
          </div>
        </div>

        <!-- Other Disabilities -->
        <div class="row mt-2 align-items-end">
          <div class="col-md-3"><label class="form-label mb-1">Other Disabilities</label></div>
          <div class="col-md-3">
            <label class="small">Male</label>
            <input type="number" class="form-control dis-other_disability-male" min="0" placeholder="M">
          </div>
          <div class="col-md-3">
            <label class="small">Female</label>
            <input type="number" class="form-control dis-other_disability-female" min="0" placeholder="F">
          </div>
          <div class="col-md-3">
            <label class="small">Others</label>
            <input type="number" class="form-control dis-other_disability-others" min="0" placeholder="O">
          </div>
        </div>

      </div>
    </template>


    <!-- Program accordion card -->
    <template id="programAccordionTemplate">
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button"></button>
        </h2>

        <div class="accordion-collapse collapse">
          <div class="accordion-body">
            <div class="row program-content-row"></div>
          </div>
        </div>
      </div>
    </template>

    <template id="metricCardTemplate">
      <div class="col-12 col-md-3 mb-3 metric-col">
        <div class="card shadow-sm">
          <div class="card-header text-white py-2 text-center fw-bold metric-title"></div>
          <div class="card-body p-2">
            <table class="table table-sm mb-0">
              <tbody class="metric-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </template>

    <template id="actionButtonsTemplate">
      <div class="d-flex justify-content-center align-items-center gap-2 action-icons">
        <a class="btn btn-sm btn-outline-primary btn-edit" title="Edit">
          <i class="bi bi-pencil-square"></i>
        </a>
        <a class="btn btn-sm btn-outline-danger btn-delete" title="Delete">
          <i class="bi bi-trash"></i>
        </a>
      </div>
    </template>

</body>

<script>
  // function to get CSRF cookie
  function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      var cookies = document.cookie.split(';');
      $.each(cookies, function (i, cookie) {
        cookie = $.trim(cookie);
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          return false; // break loop
        }
      });
    }
    return cookieValue;
  }

  // jQuery global setup: adds CSRF to every non-GET request
  $.ajaxSetup({
    beforeSend: function (xhr, settings) {
      if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type)) {
        xhr.setRequestHeader("X-CSRFToken", getCookie("csrftoken"));
      }
    },
    complete: function (xhr) {
      if (xhr.responseJSON && xhr.responseJSON.status === 302) {
        // Session expired or forbidden
        showNotification("Session expired. Please log in again.", "danger");
        window.location.href = "/home/";
      }
    }
  });

  function populateAddModal(response) {
    const data = response.college_data;

    $("#modalCollegeName").text(data.College_Name);
    $("#modalCollegeAddress").text(data.address);

    $("#programSectionsContainer").empty();

    const programsByDiscipline = data.programs || {};

    Object.entries(programsByDiscipline).forEach(([discipline, programList]) => {

      const discTpl = document.querySelector("#disciplineTemplate");
      const discClone = discTpl.content.cloneNode(true);

      // Set discipline header
      discClone.querySelector(".discipline-title").innerText = discipline;

      const programContainer = discClone.querySelector(".discipline-programs-container");

      // Loop programs
      programList.forEach(programName => {
        const progTpl = document.querySelector("#programTemplate");
        const progClone = progTpl.content.cloneNode(true);

        // Set program name
        progClone.querySelector(".program-title").innerText = programName;
        progClone.querySelector(".program-section").dataset.program = programName;

        programContainer.appendChild(progClone);
      });

      $("#programSectionsContainer").append(discClone);
    });

    $("#academicYear").val("");
    $("#collegeModal").data("college-code", data.College_Code);
  }


  function addProgramSection(disciplineName, programName) {
    const template = document.querySelector("#programTemplate");
    const clone = template.content.cloneNode(true);

    clone.querySelector(".program-title").innerText = `${programName}`;
    clone.querySelector(".program-section").dataset.program = programName;
    clone.querySelector(".program-section").dataset.discipline = disciplineName;

    return clone;
  }


  function validateProgramSection(section) {
    // section is expected to be a jQuery object for the .program-section
    const programName = section.data("program") || "Program";
    const parseVal = (el) => {
      const v = parseInt(el.val && el.val() || el || 0, 10);
      return Number.isFinite(v) ? v : 0;
    };

    const total = parseVal(section.find(".total-students"));

    if (!total || total <= 0) {
      return {
        valid: false,
        message: `${programName}: Total Students is required and must be greater than 0.`
      };
    }

    // Helper: sum a list of selectors within this section
    function sumSelectors(selectors) {
      let sum = 0;
      selectors.forEach(sel => {
        section.find(sel).each(function () {
          const v = parseInt($(this).val() || 0, 10);
          sum += (Number.isFinite(v) ? v : 0);
        });
      });
      return sum;
    }

    // --- TOP-LEVEL GENDER CHECK (existing) ---
    const topMale = parseVal(section.find(".gender-male"));
    const topFemale = parseVal(section.find(".gender-female"));
    const topOthers = parseVal(section.find(".gender-others"));
    const genderSum = topMale + topFemale + topOthers;

    if (genderSum !== total) {
      return {
        valid: false,
        message: `${programName}: Gender total (${genderSum}) does not match Total Students (${total}).`
      };
    }

    // WASHROOM VALIDATION: mandatory (cannot be empty), but 0 is allowed
    const $washTotal = section.find(".wash-total");
    const $washMale = section.find(".wash-male");
    const $washFemale = section.find(".wash-female");

    const rawWashTotal = ($washTotal.val() ?? "").trim();
    const rawWashMale = ($washMale.val() ?? "").trim();
    const rawWashFemale = ($washFemale.val() ?? "").trim();

    // must NOT be empty (but "0" is OK)
    if (rawWashTotal === "" || rawWashMale === "" || rawWashFemale === "") {
      return {
        valid: false,
        message: `${programName}: All washroom fields (Total, Male, Female) are required. They may be 0 but cannot be left blank.`
      };
    }

    const washTotal = parseInt(rawWashTotal, 10);
    const washMale = parseInt(rawWashMale, 10);
    const washFemale = parseInt(rawWashFemale, 10);

    const safeWashTotal = Number.isFinite(washTotal) ? washTotal : 0;
    const safeWashMale = Number.isFinite(washMale) ? washMale : 0;
    const safeWashFemale = Number.isFinite(washFemale) ? washFemale : 0;
    const washSum = safeWashMale + safeWashFemale;

    if (safeWashTotal !== washSum) {
      return {
        valid: false,
        message: `${programName}: Washroom total (${safeWashTotal}) does not match Male (${safeWashMale}) + Female (${safeWashFemale}).`
      };
    }

    // --- CATEGORY: compute per-category male/female/other sums and overall category total ---
    const catKeys = ["open", "obc", "sc", "st", "nt", "vjnt", "ews"];
    let categorySum = 0;
    let categoryMaleSum = 0, categoryFemaleSum = 0, categoryOtherSum = 0;

    catKeys.forEach(key => {
      const m = parseInt(section.find(`.cat-${key}-male`).val() || 0, 10) || 0;
      const f = parseInt(section.find(`.cat-${key}-female`).val() || 0, 10) || 0;
      const o = parseInt(section.find(`.cat-${key}-others`).val() || 0, 10) || 0;
      categoryMaleSum += m;
      categoryFemaleSum += f;
      categoryOtherSum += o;
      categorySum += (m + f + o);
    });

    if (categorySum !== total) {
      return {
        valid: false,
        message: `${programName}: Category total (${categorySum}) does not match Total Students (${total}).`
      };
    }

    // ensure top-level gender equals breakdown across categories
    if (topMale !== categoryMaleSum || topFemale !== categoryFemaleSum || topOthers !== categoryOtherSum) {
      return {
        valid: false,
        message: `${programName}: Top-level gender counts (M:${topMale}, F:${topFemale}, O:${topOthers}) do not match category breakdown (M:${categoryMaleSum}, F:${categoryFemaleSum}, O:${categoryOtherSum}).`
      };
    }

    // --- RELIGION: keys and sums ---
    const relKeys = ["hindu", "muslim", "sikh", "christian", "jain", "buddhist", "other_religion"];
    let religionSum = 0;
    relKeys.forEach(key => {
      const m = parseInt(section.find(`.rel-${key}-male`).val() || 0, 10) || 0;
      const f = parseInt(section.find(`.rel-${key}-female`).val() || 0, 10) || 0;
      const o = parseInt(section.find(`.rel-${key}-others`).val() || 0, 10) || 0;
      religionSum += (m + f + o);
    });

    if (religionSum !== total) {
      return {
        valid: false,
        message: `${programName}: Religion total (${religionSum}) does not match Total Students (${total}).`
      };
    }

    // --- DISABILITY: keys and sums ---
    const disKeys = ["no_disability", "lowvision", "blindness", "hearing", "locomotor", "autism", "other_disability"];
    let disabilitySum = 0;
    disKeys.forEach(key => {
      const m = parseInt(section.find(`.dis-${key}-male`).val() || 0, 10) || 0;
      const f = parseInt(section.find(`.dis-${key}-female`).val() || 0, 10) || 0;
      const o = parseInt(section.find(`.dis-${key}-others`).val() || 0, 10) || 0;
      disabilitySum += (m + f + o);
    });

    if (disabilitySum !== total) {
      return {
        valid: false,
        message: `${programName}: Disability total (${disabilitySum}) does not match Total Students (${total}).`
      };
    }

    // All checks passed
    return { valid: true };
  }


  function populateEditModal(response) {
    const data = response.college_data || {};
    const savedRecords = response.records || {};

    // header & meta
    document.getElementById("modalCollegeName").textContent = data.College_Name || "";
    document.getElementById("modalCollegeAddress").textContent = data.address || "";
    document.getElementById("academicYear").value = response.academic_year || "";

    // set modal meta for submit handler
    $("#collegeModal").data("college-code", data.College_Code || "");
    $("#collegeModal").data("mode", response.mode || "add");

    // clear previous content
    const container = document.getElementById("programSectionsContainer");
    container.innerHTML = "";

    const programsByDiscipline = data.programs || {};

    const catKeys = ["open", "obc", "sc", "st", "nt", "vjnt", "ews"];
    const relKeys = ["hindu", "muslim", "sikh", "christian", "jain", "buddhist", "other_religion"];
    const disKeys = ["no_disability", "lowvision", "blindness", "hearing", "locomotor", "autism", "other_disability"];

    const n = v => {
      const x = Number(v);
      return Number.isFinite(x) ? x : 0;
    };

    Object.entries(programsByDiscipline).forEach(([discipline, programList]) => {
      const discTpl = document.querySelector("#disciplineTemplate");
      const discFrag = discTpl.content.cloneNode(true);

      const discTitleEl = discFrag.querySelector(".discipline-title");
      if (discTitleEl) discTitleEl.textContent = discipline;

      const programContainer = discFrag.querySelector(".discipline-programs-container");
      const progBatch = document.createDocumentFragment();

      programList.forEach(programName => {
        const progTpl = document.querySelector("#programTemplate");
        const progFrag = progTpl.content.cloneNode(true);

        const sectionEl = progFrag.querySelector(".program-section");
        if (sectionEl) sectionEl.setAttribute("data-program", programName);

        const titleEl = progFrag.querySelector(".program-title");
        if (titleEl) titleEl.textContent = programName;

        const saved = savedRecords[programName] || {};

        // total students
        const totalEl = progFrag.querySelector(".total-students");
        if (totalEl) totalEl.value = saved.total_students !== undefined ? saved.total_students : "";

        // GENDER
        const g = saved.gender || { male: 0, female: 0, others: 0 };
        const gm = progFrag.querySelector(".gender-male");
        const gf = progFrag.querySelector(".gender-female");
        const go = progFrag.querySelector(".gender-others");
        if (gm) gm.value = n(g.male);
        if (gf) gf.value = n(g.female);
        if (go) go.value = n(g.others);

        // WASHROOMS (program-level)
        const w = saved.washrooms || {
          total_washrooms: 0,
          male_washrooms: 0,
          female_washrooms: 0
        };

        const wt = progFrag.querySelector(".wash-total");
        const wm = progFrag.querySelector(".wash-male");
        const wf = progFrag.querySelector(".wash-female");

        if (wt) wt.value = n(w.total_washrooms);
        if (wm) wm.value = n(w.male_washrooms);
        if (wf) wf.value = n(w.female_washrooms);

        // CATEGORY
        const cat = saved.category || {};
        catKeys.forEach(key => {
          const grp = cat[key] || { male: 0, female: 0, others: 0 };
          const maleEl = progFrag.querySelector(`.cat-${key}-male`);
          const femaleEl = progFrag.querySelector(`.cat-${key}-female`);
          const othersEl = progFrag.querySelector(`.cat-${key}-others`);
          if (maleEl) maleEl.value = n(grp.male);
          if (femaleEl) femaleEl.value = n(grp.female);
          if (othersEl) othersEl.value = n(grp.others);
        });

        // RELIGION
        const rel = saved.religion || {};
        relKeys.forEach(key => {
          const grp = rel[key] || { male: 0, female: 0, others: 0 };
          const maleEl = progFrag.querySelector(`.rel-${key}-male`);
          const femaleEl = progFrag.querySelector(`.rel-${key}-female`);
          const othersEl = progFrag.querySelector(`.rel-${key}-others`);
          if (maleEl) maleEl.value = n(grp.male);
          if (femaleEl) femaleEl.value = n(grp.female);
          if (othersEl) othersEl.value = n(grp.others);
        });

        // DISABILITY
        const dis = saved.disability || {};
        disKeys.forEach(key => {
          const grp = dis[key] || { male: 0, female: 0, others: 0 };
          const maleEl = progFrag.querySelector(`.dis-${key}-male`);
          const femaleEl = progFrag.querySelector(`.dis-${key}-female`);
          const othersEl = progFrag.querySelector(`.dis-${key}-others`);
          if (maleEl) maleEl.value = n(grp.male);
          if (femaleEl) femaleEl.value = n(grp.female);
          if (othersEl) othersEl.value = n(grp.others);
        });

        progBatch.appendChild(progFrag);
      });

      programContainer.appendChild(progBatch);
      container.appendChild(discFrag);
    });
  }


  function initStudentTable() {
    const table = $("#records_table").DataTable({
      serverSide: true,
      processing: true,
      ajax: {
        url: "/get_student_records/",
        type: "GET",
        data: function (d) {
          // always take latest selected year
          d.year = $("#globalAcademicYear").val();
        }
      },
      pageLength: 10,

      // normal layout, no DataTables Buttons
      dom: "lfrtip",

      columns: [
        {
          data: null,
          orderable: false,
          searchable: false,
          render: function () {
            return `
            <button class="btn btn-sm btn-outline-primary toggle-programs">
              <i class="bi bi-plus-lg"></i>
            </button>`;
          }
        },
        { data: "college_code" },
        { data: "college_name" },
        { data: "academic_year" },
        {
          data: "total_students",
          render: function (d) {
            return d ?? "-";
          }
        },
        {
          data: null,
          render: function (data, type, row) {
            // use jQuery instead of document.querySelector/template clone
            const $clone = $($("#actionButtonsTemplate").html().trim());

            $clone
              .find(".btn-edit")
              .attr("data-college", row.college_code)
              .attr("data-year", row.academic_year);

            $clone
              .find(".btn-delete")
              .attr("data-college", row.college_code)
              .attr("data-year", row.academic_year);

            return $("<div>").append($clone).html();
          }
        }
      ],
      order: [[2, "asc"]]
    });

    // External export button (like Page 1)
    $("#ExportStudentExcelButton").on("click", function () {
      const dt = table;
      const year = $("#globalAcademicYear").val();

      if (!year) {
        alert("Please select an academic year first.");
        return;
      }

      const payload = {
        year: year,
        search: dt.search() || "",
        order: dt.order() || []
      };

      $.ajax({
        url: "/export-student-excel/",
        method: "POST",
        data: JSON.stringify(payload),
        contentType: "application/json",
        // headers: {
        //   "X-CSRFToken": (document.cookie.match(/csrftoken=([^;]+)/) || [])[1] || ""
        // },
        xhr: function () {
          const xhr = new window.XMLHttpRequest();
          xhr.responseType = "blob";
          return xhr;
        },
        success: function (blob, status, xhr) {
          let filename = "Student_Report_" + year + ".xlsx";
          const disp = xhr.getResponseHeader("Content-Disposition");

          if (disp && disp.indexOf("filename=") !== -1) {
            const match = disp.match(/filename\*?=(?:UTF-8'')?["']?([^;"']+)["']?/);
            if (match && match[1]) {
              filename = decodeURIComponent(match[1]);
            }
          }

          const url = window.URL.createObjectURL(blob);
          const $a = $("<a style='display:none;'></a>");

          $a.attr("href", url).attr("download", filename);
          $("body").append($a);

          // trigger download
          $a[0].click();

          setTimeout(function () {
            window.URL.revokeObjectURL(url);
            $a.remove();
          }, 200);
        },
        error: function (xhr, status, err) {
          if (xhr.response && xhr.response.type === "application/json") {
            const reader = new FileReader();
            reader.onload = function () {
              try {
                const json = JSON.parse(reader.result);
                alert(
                  "Export failed: " +
                  (json.message || json.detail || JSON.stringify(json))
                );
              } catch (e) {
                alert("Export failed");
              }
            };
            reader.readAsText(xhr.response);
          } else {
            alert("Export failed: " + status);
          }
        }
      });
    });

    //  YEAR CHANGE → RELOAD TABLE
    $("#globalAcademicYear").on("change", function () {
      selectedYear = $(this).val();
      table.ajax.reload();
    });

    //  LABEL MAP FOR FULL DESCRIPTIONS
    const LABEL_MAP = {
      // Gender
      male: "Male",
      female: "Female",
      others: "Others",

      // Category
      open: "Open",
      obc: "OBC",
      sc: "SC",
      st: "ST",
      nt: "NT",
      vjnt: "VJNT",
      ews: "EWS",

      // Religion
      hindu: "Hindu",
      muslim: "Muslim",
      sikh: "Sikh",
      christian: "Christian",
      jain: "Jain",
      buddhist: "Buddhist",
      other: "Other Religions",

      // Disability
      no_disability: "No Disability",
      lowvision: "Low Vision",
      blindness: "Blindness",
      hearing: "Hearing Impaired",
      locomotor: "Locomotor Disability",
      autism: "Autism",
      other_disability: "Other Disabilities"
    };

    // BUILD FULL PROGRAM ACCORDION USING TEMPLATES
    function formatPrograms(row) {
      const wrapper = document.createElement("div");
      wrapper.className = "dt-child-scroll";

      const container = document.createElement("div");
      container.className = "container-fluid p-0";

      const inner = document.createElement("div");
      inner.className = "py-3";

      // Main accordion container
      const accordion = document.createElement("div");
      accordion.className = "accordion";
      accordion.id = `acc-${row.college_code}`;

      // row.programs = [{ discipline: "", programs: [ ... ] }]
      row.programs.forEach((group, groupIndex) => {
        // ---------------------------
        // Discipline Header (inside accordion)
        // ---------------------------
        const discHeader = document.createElement("div");
        discHeader.className = "discipline-header-row";

        const discText = document.createElement("span");
        discText.className = "discipline-header-text";
        discText.textContent = group.discipline;

        discHeader.appendChild(discText);
        accordion.appendChild(discHeader);

        // Divider for proper top border before first program
        const divider = document.createElement("div");
        divider.className = "discipline-divider";
        accordion.appendChild(divider);

        // ---------------------------
        // Programs inside this discipline
        // ---------------------------
        group.programs.forEach((p, i) => {
          const tplItem = document.querySelector("#programAccordionTemplate");
          const acc = tplItem.content.cloneNode(true);

          const btn = acc.querySelector(".accordion-button");
          // Header text: show total students here
          btn.textContent = `${p.name} (Total Students: ${p.total_students})`;
          btn.setAttribute("data-bs-toggle", "collapse");
          btn.setAttribute("data-bs-target", `#collapse-${row.college_code}-${groupIndex}-${i}`);

          const collapse = acc.querySelector(".accordion-collapse");
          collapse.id = `collapse-${row.college_code}-${groupIndex}-${i}`;
          collapse.setAttribute("data-bs-parent", `#acc-${row.college_code}`);

          const rowContainer = acc.querySelector(".program-content-row");

          // Washroom data for this program (used with Gender column)
          const wash = p.washrooms || {
            total_washrooms: 0,
            male_washrooms: 0,
            female_washrooms: 0
          };

          // ---- METRICS: 4 columns -> Gender(+Washrooms), Category, Religion, Disability
          const metricGroups = {
            "Gender": { color: "bg-primary", data: p.gender },
            "Category (M/F/O)": { color: "bg-success", data: p.category },
            "Religion (M/F/O)": { color: "bg-warning text-dark", data: p.religion },
            "Disability (M/F/O)": { color: "bg-danger", data: p.disability }
          };

          Object.entries(metricGroups).forEach(([title, meta]) => {
            const tplMetric = document.querySelector("#metricCardTemplate");
            const clone = tplMetric.content.cloneNode(true);

            const titleEl = clone.querySelector(".metric-title");
            titleEl.textContent = title;
            titleEl.classList.add(...meta.color.split(" "));

            const tbody = clone.querySelector(".metric-body");

            // handle nested {male,female,others} objects
            Object.entries(meta.data).forEach(([label, value]) => {
              const tr = document.createElement("tr");

              let displayValue;
              if (value && typeof value === "object" && ("male" in value || "female" in value || "others" in value)) {
                const m = Number.isFinite(Number(value.male)) ? Number(value.male) : 0;
                const f = Number.isFinite(Number(value.female)) ? Number(value.female) : 0;
                const o = Number.isFinite(Number(value.others)) ? Number(value.others) : 0;
                displayValue = `${m}/${f}/${o}`;
              } else {
                displayValue = (value === null || value === undefined || value === "") ? "-" : value;
              }

              tr.innerHTML = `
                <td class="text-start">${LABEL_MAP[label] || label}</td>
                <td class="text-end">${displayValue}</td>
              `;

              tbody.appendChild(tr);
            });

            // For Gender column only, add a second card (Washrooms) stacked below
            if (title === "Gender") {
              const colDiv = clone.querySelector(".metric-col") || clone.firstElementChild;

              if (colDiv) {
                const washCard = document.createElement("div");
                washCard.className = "card shadow-sm mt-2";

                washCard.innerHTML = `
              <div class="card-header bg-info text-white py-2 text-center fw-bold">
                Washrooms
              </div>
              <div class="card-body p-2">
                <table class="table table-sm mb-0">
                  <tbody>
                    <tr>
                      <td>Total</td>
                      <td class="text-end">${wash.total_washrooms ?? 0}</td>
                    </tr>
                    <tr>
                      <td>Male</td>
                      <td class="text-end">${wash.male_washrooms ?? 0}</td>
                    </tr>
                    <tr>
                      <td>Female</td>
                      <td class="text-end">${wash.female_washrooms ?? 0}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            `;

                // stack below Gender in the same col-md-3
                colDiv.appendChild(washCard);
              }
            }

            rowContainer.appendChild(clone);
          });

          accordion.appendChild(acc);
        });
      });

      inner.appendChild(accordion);
      container.appendChild(inner);
      wrapper.appendChild(container);

      return wrapper.outerHTML;
    }

    //  EXPAND / COLLAPSE CHILD ROWS
    $("#records_table tbody").on("click", ".toggle-programs", function () {

      const tr = $(this).closest("tr");
      const row = table.row(tr);
      const btn = $(this);

      if (row.child.isShown()) {
        row.child.hide();
        btn.html('<i class="bi bi-plus-lg"></i>');
      } else {
        row.child(formatPrograms(row.data())).show();
        btn.html('<i class="bi bi-dash-lg"></i>');
      }
    });
  }


  function showNotification(message, type) {
    var notificationClass = type === "success" ? "notification-success" : "notification-error";
    var notification = $('<div>', {
      class: 'notification ' + notificationClass,
      text: message
    });

    $('body').append(notification);

    setTimeout(function () {
      notification.addClass('show-notification');
    }, 10); // slight delay to ensure the element is in the DOM

    setTimeout(function () {
      notification.removeClass('show-notification');
      setTimeout(function () {
        notification.remove();
      }, 500); // additional delay to allow transition effect
    }, 3000);
  }


  $('document').ready(function () {

    $.ajax({
      url: "{% url 'user_status' %}", // backend endpoint for checking auth
      type: "GET",
      success: function (response) {
        if (response.status === 200) {
          initStudentTable()
        } else {
          window.location.href = "/home/";
        }
      },
      error: function () {
        console.error("Auth check failed");
      }
    });


    // Toggle the cassette
    $("#AddRecordButton").on("click", function (e) {
      e.stopPropagation();

      const cassette = $("#collegeCodeCassette");
      cassette.toggleClass("show");

      if (cassette.hasClass("show")) {
        // Opening → focus but DO NOT clear
        $("#collegeCodeInput").focus();
      } else {
        // Closing → clear input
        $("#collegeCodeInput").val("");
      }
    });

    // Click outside closes cassette
    $(document).on("click", function (e) {
      if (!$(e.target).closest("#collegeCodeCassette, #AddRecordButton").length) {
        $("#collegeCodeCassette").removeClass("show");
        // Clear input when closed
        $("#collegeCodeInput").val("");
      }
    });

    // Prevent inner clicks from closing it
    $("#collegeCodeCassette").on("click", function (e) {
      e.stopPropagation();
    });

    // toggle collapsible discipline
    $(document).on("click", ".toggle-discipline", function () {
      const container = $(this).closest(".discipline-wrapper").find(".discipline-programs-container");
      container.slideToggle(200);

      const icon = $(this).find("i");
      icon.toggleClass("bi-chevron-down bi-chevron-up");
    });

    // ADD MODE - When user enters college code to add new records
    $("#submitCollegeCode").on("click", function () {
      const collegeCode = $("#collegeCodeInput").val().trim();
      console.log("clicked")

      if (!collegeCode) {
        showNotification("Please enter a college code", "danger");
        return;
      }

      $.ajax({
        url: "/get-college-data/",
        type: "GET",
        data: {
          college_code: collegeCode,
          mode: "add",
          page: "student"
        },
        success: function (response) {
          if (response.status === 200 && response.mode === "add") {
            console.log(response)
            populateAddModal(response);
            $("#collegeModal").data("mode", "add");
            $("#collegeModal").modal("show");
          }
          else if (response.status === 409) {
            showNotification(response.message, "danger");
          }
          else {
            showNotification("Invalid college code", "danger");
          }
        },
        error: function () {
          showNotification("Server error", "danger");
        }
      });
    });


    $("#submitRecordForm").on("click", function () {
      const collegeCode = $("#collegeModal").data("college-code");
      const academicYear = $("#academicYear").val();
      const mode = $("#collegeModal").data("mode");

      if (!academicYear) {
        showNotification("Please select academic year", "danger");
        return;
      }

      // safe integer parser: returns 0 for empty/invalid
      function toInt(v) {
        const n = parseInt(v, 10);
        return Number.isFinite(n) ? n : 0;
      }

      let records = {};
      let failedValidation = null;

      $(".program-section").each(function () {
        let section = $(this);

        // VALIDATE THIS PROGRAM FIRST
        let check = validateProgramSection(section);
        if (!check.valid) {
          failedValidation = check.message;
          return false; // stop loop
        }

        let program =
          section.data("program") ||
          section.find(".program-title").text().trim() ||
          "program";

        // top-level totals/gender
        const total_students = toInt(section.find(".total-students").val());
        const gender = {
          male: toInt(section.find(".gender-male").val()),
          female: toInt(section.find(".gender-female").val()),
          others: toInt(section.find(".gender-others").val())
        };

        // washroom counts (per program section)
        const washrooms = {
          total: toInt(section.find(".wash-total").val()),
          male: toInt(section.find(".wash-male").val()),
          female: toInt(section.find(".wash-female").val())
        };

        // categories (each with male/female/others)
        const catKeys = ["open", "obc", "sc", "st", "nt", "vjnt", "ews"];
        const category = {};
        catKeys.forEach(key => {
          category[key] = {
            male: toInt(section.find(`.cat-${key}-male`).val()),
            female: toInt(section.find(`.cat-${key}-female`).val()),
            others: toInt(section.find(`.cat-${key}-others`).val())
          };
        });

        // religion
        const relKeys = ["hindu", "muslim", "sikh", "christian", "jain", "buddhist", "other_religion"];
        const religion = {};
        relKeys.forEach(key => {
          religion[key] = {
            male: toInt(section.find(`.rel-${key}-male`).val()),
            female: toInt(section.find(`.rel-${key}-female`).val()),
            others: toInt(section.find(`.rel-${key}-others`).val())
          };
        });

        // disability
        const disKeys = ["no_disability", "lowvision", "blindness", "hearing", "locomotor", "autism", "other_disability"];
        const disability = {};
        disKeys.forEach(key => {
          disability[key] = {
            male: toInt(section.find(`.dis-${key}-male`).val()),
            female: toInt(section.find(`.dis-${key}-female`).val()),
            others: toInt(section.find(`.dis-${key}-others`).val())
          };
        });

        // assign
        records[program] = {
          total_students: total_students,
          gender: gender,
          washrooms: washrooms,
          category: category,
          religion: religion,
          disability: disability
        };
      });

      // IF ANY PROGRAM FAILED → STOP SUBMISSION
      if (failedValidation) {
        showNotification(failedValidation, "danger");
        return;
      }

      let payload = {
        college_code: collegeCode,
        academic_year: academicYear,
        records: records
      };
      console.log(records);

      // send (URLs unchanged)
      if (mode === "add") {
        $.ajax({
          url: "/add_student/",
          type: "POST",
          data: JSON.stringify(payload),
          contentType: "application/json",
          success: function (response) {
            if (response.status === 200) {
              showNotification("Student records saved successfully!", "success");
              $("#collegeModal").modal("hide");
              table.ajax.reload(null, false);
            }
            else if (response.status === 400) {
              alert(
                `${response.message}
                 ${response.type}
                College Total Washrooms: ${response.college_total_washrooms}
                Sum of Program Washrooms: ${response.sum_of_program_washrooms_in_payload}`
              );
            }
            else {
              showNotification(response.message || "Something went wrong", "danger");
            }
          },
          error: function () {
            showNotification("Server error", "danger");
          }
        });
      } else {
        // EDIT MODE
        $.ajax({
          url: "/edit_student/",
          type: "POST",
          data: JSON.stringify(payload),
          contentType: "application/json",
          success: function (response) {
            if (response.status === 200) {
              showNotification("Student records updated successfully!", "success");
              $("#collegeModal").modal("hide");
              table.ajax.reload(null, false);

            }
            else if (response.status === 400) {
              alert(
                `${response.message}
                 ${response.type}
                College Total Washrooms: ${response.college_total_washrooms}
                Sum of Program Washrooms: ${response.sum_of_program_washrooms_in_payload}`
              );
            }
            else {
              showNotification(response.message || "Something went wrong", "danger");
            }
          },
          error: function () {
            showNotification("Server error", "danger");
          }
        });
      }
    });


    // EDIT MODE - When user clicks on "Edit"
    $(document).on("click", ".btn-edit", function (e) {
      e.preventDefault();

      const college = $(this).data("college");
      const year = $(this).data("year") || $("#globalAcademicYear").val();

      if (!college) {
        showNotification("Missing college code", "danger");
        return;
      }

      const $btn = $(this);
      $btn.prop("disabled", true).addClass("disabled");

      $.ajax({
        url: "/get-college-data/",
        type: "GET",
        data: {
          college_code: college,
          academic_year: year,
          mode: "edit",
          page:"student"
        },
        success: function (response) {
          $btn.prop("disabled", false).removeClass("disabled");

          if (response && response.status === 200) {
            populateEditModal(response);

            $("#collegeModal").data("mode", "edit");
            $("#collegeModal").data("college-code", response.college_data?.College_Code || college);

            $("#collegeModal").modal("show");
          } else {
            showNotification(response?.message || "Unable to load records", "danger");
          }
        },
        error: function (xhr) {
          $btn.prop("disabled", false).removeClass("disabled");
          let msg = "Server error";
          try {
            const json = JSON.parse(xhr.responseText);
            if (json && json.message) msg = json.message;
          } catch (e) { }
          showNotification(msg, "danger");
        }
      });
    });


    // DELETE RECORD HANDLER 
    $(document).on("click", ".btn-delete", function () {
      const college = $(this).data("college");
      const year = $(this).data("year");

      if (!college || !year) {
        showNotification("Invalid record selected.", "danger");
        return;
      }

      // Confirm deletion
      if (!confirm(`Delete records for ${college} (${year})?`)) {
        return;
      }

      $.ajax({
        url: "/delete-student-record/",
        type: "POST",
        data: {
          college_code: college,
          academic_year: year
        },
        success: function (response) {
          if (response.status === 204) {
            showNotification("Record deleted successfully.", "success");
            $("#records_table").DataTable().ajax.reload(null, false);
          } else {
            showNotification(response.message || "Delete failed", "danger");
          }
        },
        error: function () {
          showNotification("Server error", "danger");
        }
      });
    });


    $("#logout_btn").on("click", function (e) {
      e.preventDefault();
      $.ajax({
        url: "{% url 'logout' %}",
        type: "POST",
        success: function (data) {
          if (data.status === 200) {
            window.location.href = "/home/";
          }
        },
        error: function () {
          alert("Logout failed. Try again.");
        }
      });
    });

  })

</script>

</html>