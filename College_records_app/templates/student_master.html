<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- jQuery + Validation -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/jquery.validation/1.16.0/jquery.validate.min.js"></script>
  <script src="https://cdn.jsdelivr.net/jquery.validation/1.16.0/additional-methods.min.js"></script>

  <!-- DataTables -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

  <!-- Buttons CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">

  <!-- Buttons + dependencies for excel and print button -->
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>


  <title>Student Records</title>

  <style>
    /* Validation */
    label.error {
      color: #dc3545;
      font-size: 0.9rem;
    }

    body {
      background: #f8f9fa;
      font-family: "Segoe UI", Roboto, sans-serif;
      caret-color: transparent;
      margin: 0;
      padding: 0;
      height: 100%;
      overflow-x: hidden;
      overflow-y: auto;
      /* IMPORTANT */
    }

    /* Modal scroll fixes */
    .modal-dialog {
      max-width: 90%;
      margin: 1.5rem auto;
    }

    .modal-content {
      max-height: 95vh;
      overflow: hidden;
    }

    .modal-body {
      caret-color: auto;
      overflow-y: auto;
      max-height: calc(95vh - 120px);
      /* Fix overflow */
      padding-right: 15px;
    }

    /* Header */
    .header-container {
      margin-top: 0.5rem;
    }

    .header-banner {
      background: linear-gradient(135deg, #0d6efd, #198754);
      color: white;
      border-radius: 1rem;
      padding: 2.5rem 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }


    /* Table */
    .table-container {
      background: white;
      border-radius: 1rem;
      padding: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    table.dataTable thead {
      background: #0d6efd;
      color: white;
    }

    table.dataTable thead th {
      text-align: center;
      vertical-align: middle;
    }

    /* Notification styles */
    .notification {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px 30px;
      font-size: 1rem;
      font-weight: bold;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      opacity: 0;
      transition: opacity 0.5s ease-out, transform 0.5s ease-out;
      z-index: 2000;
    }

    .notification-success {
      background-color: #28a745;
      color: white;
    }

    .notification-error {
      background-color: #dc3545;
      color: white;
    }

    .show-notification {
      opacity: 1;
      transform: translateX(-50%) translateY(20px);
    }

    /* College code cassette */
    #collegeCodeCassette {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-top: 1rem;
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transition: max-height .35s ease, opacity .3s ease;
    }

    #collegeCodeCassette .inner-cassette {
      background: white;
      padding: .6rem .9rem;
      border-radius: .75rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, .08);
      border: 1px solid rgba(0, 0, 0, 0.08);
      width: auto;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    #collegeCodeCassette.show {
      max-height: 90px;
      opacity: 1;
    }

    #collegeCodeInput {
      text-align: center;
      background: #f8f9fa;
      border: 1px solid rgba(0, 0, 0, 0.1);
      width: 140px;
    }

    #collegeCodeInput:focus {
      background: #fff;
      border-color: #0d6efd;
      box-shadow: 0 0 0 0.15rem rgba(13, 110, 253, .15);
    }

    /* Fix right white space in DataTables child accordion */
    .dt-child-scroll .row {
      margin-left: 0 !important;
      margin-right: 0 !important;
    }

    /* Ensure accordion inside DataTable row uses 100% width */
    .dt-child-scroll .accordion-item,
    .dt-child-scroll .accordion-button,
    .dt-child-scroll .accordion-body,
    .dt-child-scroll .container-fluid,
    .dt-child-scroll .row {
      width: 100% !important;
      max-width: 100% !important;
      overflow-x: hidden;
    }

    /* ------------------------------
   DISCIPLINE HEADER STYLING
------------------------------ */
    .discipline-wrapper {
      background: #f1f5f9;
      border: 1px solid #d6dbe1;
      padding: 1rem 1.2rem;
      border-radius: 12px;
      margin-bottom: 2rem;
    }

    .discipline-title {
      font-size: 1.35rem !important;
      font-weight: 700 !important;
      color: #0d6efd !important;
    }

    .toggle-discipline i {
      font-size: 1.1rem;
    }

    /* ------------------------------
   PROGRAM BLOCK STYLING
------------------------------ */
    .program-section {
      background: #ffffff;
      border: 1px solid #e3e6ea;
      border-radius: 10px;
      padding: 1rem 1.2rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      transition: box-shadow 0.2s ease;
    }

    .program-section:hover {
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    }

    /* Program Title */
    .program-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: #198754;
      margin-bottom: 10px;
    }

    /* ------------------------------
   SECTION HEADINGS (Gender / Category / Religion etc.)
------------------------------ */
    .program-section h6 {
      font-size: 1.1rem !important;
      font-weight: 700 !important;
      color: #333 !important;
      margin-top: 1.2rem !important;
      padding-bottom: 5px;
      border-bottom: 2px solid #dee2e6;
    }

    /* “Total Students” label */
    .program-section label.fw-semibold {
      font-size: 1.05rem;
      font-weight: 600 !important;
    }

    /* ------------------------------
   FORM INPUT SPACING
------------------------------ */
    .program-section .row {
      margin-bottom: 0.6rem;
    }

    .program-section input {
      border-radius: 6px !important;
    }

    /* ------------------------------
   SEPARATOR LINE between programs
------------------------------ */
    .discipline-programs-container .program-section:not(:last-child) {
      border-bottom: 2px dashed #d2d6da;
      padding-bottom: 1.2rem;
      margin-bottom: 1.5rem;
    }

    /* ------------------------------
   Smooth collapse animation
------------------------------ */
    .discipline-programs-container {
      overflow: hidden;
    }

    /* ------------------------------
   CLEAN DISCIPLINE HEADER (DATATABLE ACCORDION)
------------------------------ */

    .discipline-header-row {
      display: flex;
      align-items: center;
      padding: 2px 4px;
      margin: 4px 0 2px 0;
      width: 100%;
    }

    .discipline-header-text {
      font-size: 1rem;
      /* same size as program titles */
      font-weight: 600;
      color: #0d6efd;
      text-align: left;
      display: inline-block;
    }

    /* subtle divider between discipline header and programs */
    .discipline-divider {
      border-top: 1px solid #d7dce2;
      margin: 4px 0 10px 0;
    }

    /* Override Bootstrap accordion spacing interference */
    .accordion .discipline-header-row,
    .accordion .discipline-header-text {
      padding-left: 0 !important;
      margin-left: 0 !important;
      text-align: left !important;
    }

    /* minimal: let program cards fill the available width, flex-based and responsive */
    .program-content-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      /* small spacing between cards */
      padding-left: 0;
      /* safe, scoped */
      padding-right: 0;
    }

    .metric-col {
      flex: 1 1 16%;
      /* allow cards to grow; target ~6 per row */
      min-width: 140px;
      /* prevents cards from collapsing too small */
      max-width: 22%;
      /* prevents each card from becoming too wide on large screens */
      box-sizing: border-box;
    }


    /* =========================================================
   MODAL HEADER - MATCH PAGE GRADIENT
   ========================================================= */
    #collegeModal .modal-header {
      background: linear-gradient(135deg, #0d6efd, #198754) !important;
      color: #fff !important;
      border-top-left-radius: 1rem !important;
      border-top-right-radius: 1rem !important;
      padding: 1.4rem 1.6rem !important;
    }

    /* Make close button white */
    #collegeModal .btn-close {
      filter: invert(1) brightness(200%) !important;
      opacity: 0.9;
    }

    #collegeModal .btn-close:hover {
      opacity: 1;
    }

    /* Ensure college name + address become white */
    #modalCollegeName {
      color: #fff !important;
    }

    #modalCollegeAddress {
      color: rgba(255, 255, 255, 0.9) !important;
    }

    /* Fix white tips on modal header corners */
    #collegeModal .modal-content {
      background: #ffffff;
      border-top-left-radius: 0 !important;
      border-top-right-radius: 0 !important;
      overflow: visible !important;
      /* allow header to round properly */
    }

    /* Ensure FULL modal box has smooth corner radius except header */
    #collegeModal .modal-dialog {
      border-radius: 1rem !important;
      overflow: hidden;
      /* clips corners cleanly */
    }

    /* Reapply bottom corners to modal-content */
    #collegeModal .modal-content {
      border-bottom-left-radius: 1rem !important;
      border-bottom-right-radius: 1rem !important;
    }
  </style>
</head>

<body>
  <!-- Student Records -->
  <div class="container-fluid">
    <div class="row">
      <div class="col-lg-12 mx-auto">
        <div class="header-container text-center">
          <div class="header-banner position-relative">
            <div class="position-absolute top-0 end-0 p-3 text-end">
              <!-- Welcome Text -->
              <span id="welcome_msg" class="text-light fw-semibold d-block mb-1">
                Welcome, {{ request.user.username }}
              </span>

              <!-- TOP ROW: Logout + Export -->
              <div class="d-flex justify-content-end align-items-center gap-2 mb-2">

                <!-- Logout -->
                <button id="logout_btn" class="btn btn-outline-light btn-sm logout-btn">
                  <i class="bi bi-box-arrow-right"></i> Logout
                </button>

                <!-- Export Excel (small button) -->
                <button type="button" class="btn btn-warning btn-sm shadow-sm" id="ExportStudentExcelButton">
                  <i class="bi bi-file-earmark-excel"></i>
                  Export to Excel
                </button>

              </div>

              <!-- BOTTOM ROW: Academic Year -->
              <div class="d-flex justify-content-end align-items-center mt-1">

                <div class="text-light small me-2 fw-semibold">Academic Year</div>

                <select id="globalAcademicYear" class="form-select form-select-sm" style="width: 110px;">
                  {% for year in academic_year %}
                  <option value="{{ year.Academic_Year }}">{{ year.Academic_Year }}</option>
                  {% endfor %}
                </select>

              </div>

            </div>



            <h1 class="fw-bold">Student Records</h1>
            <p>Add your student record here</p>
            <button type="button" class="btn btn-success btn-lg shadow-sm" id="AddRecordButton">
              <i class="bi bi-plus-lg"></i> Add Record
            </button>

            <!-- Cascading Input Cassette -->
            <div id="collegeCodeCassette" class="cassette">
              <div class="inner-cassette d-flex align-items-center gap-2">
                <input type="text" id="collegeCodeInput" class="form-control form-control-sm" placeholder="College code"
                  inputmode="numeric">
                <button class="btn btn-primary btn-sm" id="submitCollegeCode">Submit</button>
              </div>
            </div>


          </div>


          <div class="table-container" id="datatable_wrapper">
            <table id="records_table" class="table table-hover align-middle" width="100%">
              <thead>
                <tr>
                  <th>Action</th>
                  <th>College Code</th>
                  <th>College Name</th>
                  <th>Academic Year</th>
                  <th>Total Students</th>
                  <th>Edit/Delete</th>
                </tr>
              </thead>
            </table>

          </div>

        </div>
      </div>
    </div>


    <!-- Add Student Records Modal -->
    <div class="modal fade" id="collegeModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">

          <div class="modal-header">
            <div>
              <h2 class="fw-bold mb-0" id="modalCollegeName"></h2>
              <small class="text-muted" id="modalCollegeAddress"></small>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">

            <!-- Academic Year -->
            <div class="col-md-4">
              <label class="fw-semibold">Academic Year</label>
              <select id="academicYear" class="form-select">
                <option value="">Select Year</option>
                {% for year in academic_year %}
                <option value="{{ year.Academic_Year }}">{{ year.Academic_Year }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Dynamic Program Sections Will Appear Here -->
            <div id="programSectionsContainer" class="mt-4"></div>

          </div>

          <div class="modal-footer">
            <button class="btn btn-success" id="submitRecordForm">Submit Records</button>
          </div>

        </div>
      </div>
    </div>

    <!-- DISCIPLINE WRAPPER TEMPLATE -->
    <template id="disciplineTemplate">
      <div class="discipline-wrapper mb-4 border rounded p-3 bg-light shadow-sm">

        <div class="d-flex align-items-center justify-content-between mb-2">
          <h3 class="fw-bold text-primary discipline-title mb-0"></h3>

          <button class="btn btn-sm btn-outline-secondary toggle-discipline">
            <i class="bi bi-chevron-down"></i>
          </button>
        </div>

        <!-- Holds ALL PROGRAM SECTIONS under this discipline -->
        <div class="discipline-programs-container mt-2"></div>

      </div>
    </template>

    <template id="programTemplate">
      <div class="program-section mb-4 p-3 border rounded shadow-sm bg-white">

        <h4 class="fw-bold text-dark program-title mb-3"></h4>

        <!-- TOTAL STUDENTS -->
        <h6 class="fw-bold text-secondary border-bottom pb-1">Total Students</h6>
        <div class="row mt-2">
          <div class="col-md-4">
            <input type="number" class="form-control total-students" placeholder="Enter total students" min="0">
          </div>
        </div>

        <!-- GENDER COUNT -->
        <h6 class="fw-bold text-secondary border-bottom pb-1 mt-4">Gender Count</h6>
        <div class="row mt-2">
          <div class="col-md-3"> <label>Male</label> <input type="number" class="form-control gender-male" min="0">
          </div>
          <div class="col-md-3"> <label>Female</label> <input type="number" class="form-control gender-female" min="0">
          </div>
          <div class="col-md-3"> <label>Others</label> <input type="number" class="form-control gender-others" min="0">
          </div>
        </div>

        <!-- Immediately after total: quick per-subcategory gender breakdown header -->
        <div class="row mt-3">
          <div class="col-12">
            <small class="text-muted">For each subcategory below enter Male / Female / Others counts</small>
          </div>
        </div>

        <!-- ---------------------------
         CATEGORY COUNT (each subcategory now has 3 inputs: M / F / O)
         --------------------------- -->
        <h6 class="fw-bold text-secondary border-bottom pb-1 mt-4">Category Count</h6>

        <!-- OPEN -->
        <div class="row mt-2 align-items-end">
          <div class="col-md-3">
            <label class="form-label mb-1">Open (OPEN)</label>
          </div>
          <div class="col-md-3">
            <label class="small">Male</label>
            <input type="number" class="form-control cat-open-male" min="0" placeholder="M">
          </div>
          <div class="col-md-3">
            <label class="small">Female</label>
            <input type="number" class="form-control cat-open-female" min="0" placeholder="F">
          </div>
          <div class="col-md-3">
            <label class="small">Others</label>
            <input type="number" class="form-control cat-open-others" min="0" placeholder="O">
          </div>
        </div>

        <!-- OBC -->
        <div class="row mt-2 align-items-end">
          <div class="col-md-3">
            <label class="form-label mb-1">Other Backward Class (OBC)</label>
          </div>
          <div class="col-md-3">
            <label class="small">Male</label>
            <input type="number" class="form-control cat-obc-male" min="0" placeholder="M">
          </div>
          <div class="col-md-3">
            <label class="small">Female</label>
            <input type="number" class="form-control cat-obc-female" min="0" placeholder="F">
          </div>
          <div class="col-md-3">
            <label class="small">Others</label>
            <input type="number" class="form-control cat-obc-others" min="0" placeholder="O">
          </div>
        </div>

        <!-- SC -->
        <div class="row mt-2 align-items-end">
          <div class="col-md-3">
            <label class="form-label mb-1">Scheduled Caste (SC)</label>
          </div>
          <div class="col-md-3">
            <label class="small">Male</label>
            <input type="number" class="form-control cat-sc-male" min="0" placeholder="M">
          </div>
          <div class="col-md-3">
            <label class="small">Female</label>
            <input type="number" class="form-control cat-sc-female" min="0" placeholder="F">
          </div>
          <div class="col-md-3">
            <label class="small">Others</label>
            <input type="number" class="form-control cat-sc-others" min="0" placeholder="O">
          </div>
        </div>

        <!-- ST -->
        <div class="row mt-2 align-items-end">
          <div class="col-md-3">
            <label class="form-label mb-1">Scheduled Tribe (ST)</label>
          </div>
          <div class="col-md-3">
            <label class="small">Male</label>
            <input type="number" class="form-control cat-st-male" min="0" placeholder="M">
          </div>
          <div class="col-md-3">
            <label class="small">Female</label>
            <input type="number" class="form-control cat-st-female" min="0" placeholder="F">
          </div>
          <div class="col-md-3">
            <label class="small">Others</label>
            <input type="number" class="form-control cat-st-others" min="0" placeholder="O">
          </div>
        </div>

        <!-- NT / VJNT / EWS -->
        <div class="row mt-2 align-items-end">
          <div class="col-md-3">
            <label class="form-label mb-1">Nomadic Tribe (NT)</label>
          </div>
          <div class="col-md-3">
            <label class="small">Male</label>
            <input type="number" class="form-control cat-nt-male" min="0" placeholder="M">
          </div>
          <div class="col-md-3">
            <label class="small">Female</label>
            <input type="number" class="form-control cat-nt-female" min="0" placeholder="F">
          </div>
          <div class="col-md-3">
            <label class="small">Others</label>
            <input type="number" class="form-control cat-nt-others" min="0" placeholder="O">
          </div>
        </div>

        <div class="row mt-2 align-items-end">
          <div class="col-md-3">
            <label class="form-label mb-1">VJNT (Vimukta Jati Nomadic Tribe)</label>
          </div>
          <div class="col-md-3">
            <label class="small">Male</label>
            <input type="number" class="form-control cat-vjnt-male" min="0" placeholder="M">
          </div>
          <div class="col-md-3">
            <label class="small">Female</label>
            <input type="number" class="form-control cat-vjnt-female" min="0" placeholder="F">
          </div>
          <div class="col-md-3">
            <label class="small">Others</label>
            <input type="number" class="form-control cat-vjnt-others" min="0" placeholder="O">
          </div>
        </div>

        <div class="row mt-2 align-items-end">
          <div class="col-md-3">
            <label class="form-label mb-1">Economically Weaker Section (EWS)</label>
          </div>
          <div class="col-md-3">
            <label class="small">Male</label>
            <input type="number" class="form-control cat-ews-male" min="0" placeholder="M">
          </div>
          <div class="col-md-3">
            <label class="small">Female</label>
            <input type="number" class="form-control cat-ews-female" min="0" placeholder="F">
          </div>
          <div class="col-md-3">
            <label class="small">Others</label>
            <input type="number" class="form-control cat-ews-others" min="0" placeholder="O">
          </div>
        </div>

        <!-- ---------------------------
         RELIGION COUNT (same pattern)
         --------------------------- -->
        <h6 class="fw-bold text-secondary border-bottom pb-1 mt-4">Religion Count</h6>

        <!-- Hindu -->
        <div class="row mt-2 align-items-end">
          <div class="col-md-3"><label class="form-label mb-1">Hindu</label></div>
          <div class="col-md-3"><label class="small">Male</label><input type="number"
              class="form-control rel-hindu-male" min="0"></div>
          <div class="col-md-3"><label class="small">Female</label><input type="number"
              class="form-control rel-hindu-female" min="0"></div>
          <div class="col-md-3"><label class="small">Others</label><input type="number"
              class="form-control rel-hindu-others" min="0"></div>
        </div>

        <!-- Muslim -->
        <div class="row mt-2 align-items-end">
          <div class="col-md-3"><label class="form-label mb-1">Muslim</label></div>
          <div class="col-md-3"><label class="small">Male</label><input type="number"
              class="form-control rel-muslim-male" min="0"></div>
          <div class="col-md-3"><label class="small">Female</label><input type="number"
              class="form-control rel-muslim-female" min="0"></div>
          <div class="col-md-3"><label class="small">Others</label><input type="number"
              class="form-control rel-muslim-others" min="0"></div>
        </div>

        <!-- Sikh -->
        <div class="row mt-2 align-items-end">
          <div class="col-md-3"><label class="form-label mb-1">Sikh</label></div>
          <div class="col-md-3"><label class="small">Male</label><input type="number" class="form-control rel-sikh-male"
              min="0"></div>
          <div class="col-md-3"><label class="small">Female</label><input type="number"
              class="form-control rel-sikh-female" min="0"></div>
          <div class="col-md-3"><label class="small">Others</label><input type="number"
              class="form-control rel-sikh-others" min="0"></div>
        </div>

        <!-- Christian -->
        <div class="row mt-2 align-items-end">
          <div class="col-md-3"><label class="form-label mb-1">Christian</label></div>
          <div class="col-md-3"><label class="small">Male</label><input type="number"
              class="form-control rel-christian-male" min="0"></div>
          <div class="col-md-3"><label class="small">Female</label><input type="number"
              class="form-control rel-christian-female" min="0"></div>
          <div class="col-md-3"><label class="small">Others</label><input type="number"
              class="form-control rel-christian-others" min="0"></div>
        </div>

        <!-- Jain / Buddhist / Other -->
        <div class="row mt-2 align-items-end">
          <div class="col-md-3"><label class="form-label mb-1">Jain</label></div>
          <div class="col-md-3"><label class="small">Male</label><input type="number" class="form-control rel-jain-male"
              min="0"></div>
          <div class="col-md-3"><label class="small">Female</label><input type="number"
              class="form-control rel-jain-female" min="0"></div>
          <div class="col-md-3"><label class="small">Others</label><input type="number"
              class="form-control rel-jain-others" min="0"></div>
        </div>

        <div class="row mt-2 align-items-end">
          <div class="col-md-3"><label class="form-label mb-1">Buddhist</label></div>
          <div class="col-md-3"><label class="small">Male</label><input type="number"
              class="form-control rel-buddhist-male" min="0"></div>
          <div class="col-md-3"><label class="small">Female</label><input type="number"
              class="form-control rel-buddhist-female" min="0"></div>
          <div class="col-md-3"><label class="small">Others</label><input type="number"
              class="form-control rel-buddhist-others" min="0"></div>
        </div>

        <div class="row mt-2 align-items-end">
          <div class="col-md-3"><label class="form-label mb-1">Other Religions</label></div>
          <div class="col-md-3"><label class="small">Male</label><input type="number"
              class="form-control rel-other-male" min="0"></div>
          <div class="col-md-3"><label class="small">Female</label><input type="number"
              class="form-control rel-other-female" min="0"></div>
          <div class="col-md-3"><label class="small">Others</label><input type="number"
              class="form-control rel-other-others" min="0"></div>
        </div>

        <!-- ---------------------------
         DISABILITY COUNT (same pattern)
         --------------------------- -->
        <h6 class="fw-bold text-secondary border-bottom pb-1 mt-4">Disability Count</h6>

        <div class="row mt-2 align-items-end">
          <div class="col-md-3"><label class="form-label mb-1">No Disability</label></div>
          <div class="col-md-3"><label class="small">Male</label><input type="number" class="form-control dis-no_disability-male"
              min="0"></div>
          <div class="col-md-3"><label class="small">Female</label><input type="number"
              class="form-control dis-no_disability-female" min="0"></div>
          <div class="col-md-3"><label class="small">Others</label><input type="number"
              class="form-control dis-no_disability-others" min="0"></div>
        </div>

        <div class="row mt-2 align-items-end">
          <div class="col-md-3"><label class="form-label mb-1">Low Vision</label></div>
          <div class="col-md-3"><label class="small">Male</label><input type="number"
              class="form-control dis-lowvision-male" min="0"></div>
          <div class="col-md-3"><label class="small">Female</label><input type="number"
              class="form-control dis-lowvision-female" min="0"></div>
          <div class="col-md-3"><label class="small">Others</label><input type="number"
              class="form-control dis-lowvision-others" min="0"></div>
        </div>

        <div class="row mt-2 align-items-end">
          <div class="col-md-3"><label class="form-label mb-1">Blindness</label></div>
          <div class="col-md-3"><label class="small">Male</label><input type="number"
              class="form-control dis-blindness-male" min="0"></div>
          <div class="col-md-3"><label class="small">Female</label><input type="number"
              class="form-control dis-blindness-female" min="0"></div>
          <div class="col-md-3"><label class="small">Others</label><input type="number"
              class="form-control dis-blindness-others" min="0"></div>
        </div>

        <div class="row mt-2 align-items-end">
          <div class="col-md-3"><label class="form-label mb-1">Hearing Impaired</label></div>
          <div class="col-md-3"><label class="small">Male</label><input type="number"
              class="form-control dis-hearing-male" min="0"></div>
          <div class="col-md-3"><label class="small">Female</label><input type="number"
              class="form-control dis-hearing-female" min="0"></div>
          <div class="col-md-3"><label class="small">Others</label><input type="number"
              class="form-control dis-hearing-others" min="0"></div>
        </div>

        <div class="row mt-2 align-items-end">
          <div class="col-md-3"><label class="form-label mb-1">Locomotor Disability</label></div>
          <div class="col-md-3"><label class="small">Male</label><input type="number"
              class="form-control dis-locomotor-male" min="0"></div>
          <div class="col-md-3"><label class="small">Female</label><input type="number"
              class="form-control dis-locomotor-female" min="0"></div>
          <div class="col-md-3"><label class="small">Others</label><input type="number"
              class="form-control dis-locomotor-others" min="0"></div>
        </div>

        <div class="row mt-2 align-items-end">
          <div class="col-md-3"><label class="form-label mb-1">Autism</label></div>
          <div class="col-md-3"><label class="small">Male</label><input type="number"
              class="form-control dis-autism-male" min="0"></div>
          <div class="col-md-3"><label class="small">Female</label><input type="number"
              class="form-control dis-autism-female" min="0"></div>
          <div class="col-md-3"><label class="small">Others</label><input type="number"
              class="form-control dis-autism-others" min="0"></div>
        </div>

        <div class="row mt-2 align-items-end">
          <div class="col-md-3"><label class="form-label mb-1">Other Disabilities</label></div>
          <div class="col-md-3"><label class="small">Male</label><input type="number"
              class="form-control dis-other-male" min="0"></div>
          <div class="col-md-3"><label class="small">Female</label><input type="number"
              class="form-control dis-other-female" min="0"></div>
          <div class="col-md-3"><label class="small">Others</label><input type="number"
              class="form-control dis-other-others" min="0"></div>
        </div>

      </div>
    </template>


    <template id="programAccordionTemplate">
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button"></button>
        </h2>

        <div class="accordion-collapse collapse">
          <div class="accordion-body">
            <div class="row program-content-row"></div>
          </div>
        </div>
      </div>
    </template>

    <template id="metricCardTemplate">
      <div class="col-md-2 mb-3 metric-col">
        <div class="card shadow-sm">
          <div class="card-header text-white py-2 text-center fw-bold metric-title"></div>
          <div class="card-body p-2">
            <table class="table table-sm mb-0">
              <tbody class="metric-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </template>

    <template id="totalCardTemplate">
      <div class="col-md-2 mb-3">
        <div class="card shadow-sm">
          <div class="card-header bg-secondary text-white py-2 text-center fw-bold">Total</div>
          <div class="card-body p-2">
            <h4 class="text-center fw-bold mb-0 total-value"></h4>
          </div>
        </div>
      </div>
    </template>

    <template id="actionButtonsTemplate">
      <div class="d-flex justify-content-center align-items-center gap-2 action-icons">
        <a class="btn btn-sm btn-outline-primary btn-edit" title="Edit">
          <i class="bi bi-pencil-square"></i>
        </a>
        <a class="btn btn-sm btn-outline-danger btn-delete" title="Delete">
          <i class="bi bi-trash"></i>
        </a>
      </div>
    </template>

</body>

<script>
  // function to get CSRF cookie
  function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      var cookies = document.cookie.split(';');
      $.each(cookies, function (i, cookie) {
        cookie = $.trim(cookie);
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          return false; // break loop
        }
      });
    }
    return cookieValue;
  }

  // jQuery global setup: adds CSRF to every non-GET request
  $.ajaxSetup({
    beforeSend: function (xhr, settings) {
      if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type)) {
        xhr.setRequestHeader("X-CSRFToken", getCookie("csrftoken"));
      }
    },
    complete: function (xhr) {
      if (xhr.responseJSON && xhr.responseJSON.status === 302) {
        // Session expired or forbidden
        showNotification("Session expired. Please log in again.", "danger");
        window.location.href = "/home/";
      }
    }
  });

  function populateAddModal(response) {
    const data = response.college_data;

    $("#modalCollegeName").text(data.College_Name);
    $("#modalCollegeAddress").text(data.address);

    $("#programSectionsContainer").empty();

    const programsByDiscipline = data.programs || {};

    Object.entries(programsByDiscipline).forEach(([discipline, programList]) => {

      const discTpl = document.querySelector("#disciplineTemplate");
      const discClone = discTpl.content.cloneNode(true);

      // Set discipline header
      discClone.querySelector(".discipline-title").innerText = discipline;

      const programContainer = discClone.querySelector(".discipline-programs-container");

      // Loop programs
      programList.forEach(programName => {
        const progTpl = document.querySelector("#programTemplate");
        const progClone = progTpl.content.cloneNode(true);

        // Set program name
        progClone.querySelector(".program-title").innerText = programName;
        progClone.querySelector(".program-section").dataset.program = programName;

        programContainer.appendChild(progClone);
      });

      $("#programSectionsContainer").append(discClone);
    });

    $("#academicYear").val("");
    $("#collegeModal").data("college-code", data.College_Code);
  }


  function addProgramSection(disciplineName, programName) {
    const template = document.querySelector("#programTemplate");
    const clone = template.content.cloneNode(true);

    clone.querySelector(".program-title").innerText = `${programName}`;
    clone.querySelector(".program-section").dataset.program = programName;
    clone.querySelector(".program-section").dataset.discipline = disciplineName;

    return clone;
  }



  function validateProgramSection(section) {
    // section is expected to be a jQuery object for the .program-section
    const programName = section.data("program") || "Program";
    const parseVal = (el) => {
      const v = parseInt(el.val && el.val() || el || 0, 10);
      return Number.isFinite(v) ? v : 0;
    };

    const total = parseVal(section.find(".total-students"));

    if (!total || total <= 0) {
      return {
        valid: false,
        message: `${programName}: Total Students is required and must be greater than 0.`
      };
    }

    // Helper: sum a list of selectors within this section
    function sumSelectors(selectors) {
      let sum = 0;
      selectors.forEach(sel => {
        section.find(sel).each(function () {
          const v = parseInt($(this).val() || 0, 10);
          sum += (Number.isFinite(v) ? v : 0);
        });
      });
      return sum;
    }

    // --- TOP-LEVEL GENDER CHECK (existing) ---
    const topMale = parseVal(section.find(".gender-male"));
    const topFemale = parseVal(section.find(".gender-female"));
    const topOthers = parseVal(section.find(".gender-others"));
    const genderSum = topMale + topFemale + topOthers;

    if (genderSum !== total) {
      return {
        valid: false,
        message: `${programName}: Gender total (${genderSum}) does not match Total Students (${total}).`
      };
    }

    // --- CATEGORY: compute per-category male/female/other sums and overall category total ---
    const catKeys = ["open", "obc", "sc", "st", "nt", "vjnt", "ews"];
    let categorySum = 0;
    let categoryMaleSum = 0, categoryFemaleSum = 0, categoryOtherSum = 0;

    catKeys.forEach(key => {
      const m = parseInt(section.find(`.cat-${key}-male`).val() || 0, 10) || 0;
      const f = parseInt(section.find(`.cat-${key}-female`).val() || 0, 10) || 0;
      const o = parseInt(section.find(`.cat-${key}-others`).val() || 0, 10) || 0;
      categoryMaleSum += m;
      categoryFemaleSum += f;
      categoryOtherSum += o;
      categorySum += (m + f + o);
    });

    if (categorySum !== total) {
      return {
        valid: false,
        message: `${programName}: Category total (${categorySum}) does not match Total Students (${total}).`
      };
    }

    // ensure top-level gender equals breakdown across categories
    if (topMale !== categoryMaleSum || topFemale !== categoryFemaleSum || topOthers !== categoryOtherSum) {
      return {
        valid: false,
        message: `${programName}: Top-level gender counts (M:${topMale}, F:${topFemale}, O:${topOthers}) do not match category breakdown (M:${categoryMaleSum}, F:${categoryFemaleSum}, O:${categoryOtherSum}).`
      };
    }

    // --- RELIGION: keys and sums ---
    const relKeys = ["hindu", "muslim", "sikh", "christian", "jain", "buddhist", "other"];
    let religionSum = 0;
    relKeys.forEach(key => {
      const m = parseInt(section.find(`.rel-${key}-male`).val() || 0, 10) || 0;
      const f = parseInt(section.find(`.rel-${key}-female`).val() || 0, 10) || 0;
      const o = parseInt(section.find(`.rel-${key}-others`).val() || 0, 10) || 0;
      religionSum += (m + f + o);
    });

    if (religionSum !== total) {
      return {
        valid: false,
        message: `${programName}: Religion total (${religionSum}) does not match Total Students (${total}).`
      };
    }

    // --- DISABILITY: keys and sums ---
    const disKeys = ["no_disability", "lowvision", "blindness", "hearing", "locomotor", "autism", "other"];
    let disabilitySum = 0;
    disKeys.forEach(key => {
      const m = parseInt(section.find(`.dis-${key}-male`).val() || 0, 10) || 0;
      const f = parseInt(section.find(`.dis-${key}-female`).val() || 0, 10) || 0;
      const o = parseInt(section.find(`.dis-${key}-others`).val() || 0, 10) || 0;
      disabilitySum += (m + f + o);
    });

    if (disabilitySum !== total) {
      return {
        valid: false,
        message: `${programName}: Disability total (${disabilitySum}) does not match Total Students (${total}).`
      };
    }

    // All checks passed
    return { valid: true };
  }


  function populateEditModal(response) {
    const data = response.college_data || {};
    const savedRecords = response.records || {};

    // header & meta
    document.getElementById("modalCollegeName").textContent = data.College_Name || "";
    document.getElementById("modalCollegeAddress").textContent = data.address || "";
    document.getElementById("academicYear").value = response.academic_year || "";

    // set modal meta for submit handler
    $("#collegeModal").data("college-code", data.College_Code || "");
    $("#collegeModal").data("mode", response.mode || "add");

    // clear previous content
    const container = document.getElementById("programSectionsContainer");
    container.innerHTML = "";

    const programsByDiscipline = data.programs || {};

    // keys (used in template classnames: cat-<key>-male, rel-<key>-female, dis-<key>-others)
    const catKeys = ["open", "obc", "sc", "st", "nt", "vjnt", "ews"];
    const relKeys = ["hindu", "muslim", "sikh", "christian", "jain", "buddhist", "other"];
    const disKeys = ["no_disability", "lowvision", "blindness", "hearing", "locomotor", "autism", "other"];

    // small helper to coerce to integer default 0
    const n = v => {
      const x = Number(v);
      return Number.isFinite(x) ? x : 0;
    };

    // iterate disciplines
    Object.entries(programsByDiscipline).forEach(([discipline, programList]) => {
      const discTpl = document.querySelector("#disciplineTemplate");
      const discFrag = discTpl.content.cloneNode(true);

      // set discipline title once
      const discTitleEl = discFrag.querySelector(".discipline-title");
      if (discTitleEl) discTitleEl.textContent = discipline;

      const programContainer = discFrag.querySelector(".discipline-programs-container");

      // build programs fragment to minimize reflows
      const progBatch = document.createDocumentFragment();

      programList.forEach(programName => {
        const progTpl = document.querySelector("#programTemplate");
        const progFrag = progTpl.content.cloneNode(true);

        // find the program section root inside the cloned fragment
        const sectionEl = progFrag.querySelector(".program-section");
        if (sectionEl) sectionEl.setAttribute("data-program", programName);

        const titleEl = progFrag.querySelector(".program-title");
        if (titleEl) titleEl.textContent = programName;

        // quickly set total & triplet fields using native selectors (fewer lookups)
        const saved = savedRecords[programName] || {};

        // total students
        const totalEl = progFrag.querySelector(".total-students");
        if (totalEl) totalEl.value = saved.total_students !== undefined ? saved.total_students : "";

        // gender
        const g = saved.gender || { male: 0, female: 0, others: 0 };
        const gm = progFrag.querySelector(".gender-male");
        const gf = progFrag.querySelector(".gender-female");
        const go = progFrag.querySelector(".gender-others");
        if (gm) gm.value = n(g.male);
        if (gf) gf.value = n(g.female);
        if (go) go.value = n(g.others);

        // categories
        const cat = saved.category || {};
        catKeys.forEach(key => {
          const grp = cat[key] || { male: 0, female: 0, others: 0 };
          const maleEl = progFrag.querySelector(`.cat-${key}-male`);
          const femaleEl = progFrag.querySelector(`.cat-${key}-female`);
          const othersEl = progFrag.querySelector(`.cat-${key}-others`);
          if (maleEl) maleEl.value = n(grp.male);
          if (femaleEl) femaleEl.value = n(grp.female);
          if (othersEl) othersEl.value = n(grp.others);
        });

        // religion
        const rel = saved.religion || {};
        relKeys.forEach(key => {
          const grp = rel[key] || { male: 0, female: 0, others: 0 };
          const maleEl = progFrag.querySelector(`.rel-${key}-male`);
          const femaleEl = progFrag.querySelector(`.rel-${key}-female`);
          const othersEl = progFrag.querySelector(`.rel-${key}-others`);
          if (maleEl) maleEl.value = n(grp.male);
          if (femaleEl) femaleEl.value = n(grp.female);
          if (othersEl) othersEl.value = n(grp.others);
        });

        // disability
        const dis = saved.disability || {};
        disKeys.forEach(key => {
          const grp = dis[key] || { male: 0, female: 0, others: 0 };
          const maleEl = progFrag.querySelector(`.dis-${key}-male`);
          const femaleEl = progFrag.querySelector(`.dis-${key}-female`);
          const othersEl = progFrag.querySelector(`.dis-${key}-others`);
          if (maleEl) maleEl.value = n(grp.male);
          if (femaleEl) femaleEl.value = n(grp.female);
          if (othersEl) othersEl.value = n(grp.others);
        });

        progBatch.appendChild(progFrag);
      });

      // append all programs for this discipline and then the discipline block
      programContainer.appendChild(progBatch);
      container.appendChild(discFrag);
    });
  }




  $('document').ready(function () {

    $.ajax({
      url: "{% url 'user_status' %}", // backend endpoint for checking auth
      type: "GET",
      success: function (response) {
        if (response.status === 200) {
          // add datatable initialization
        } else {
          window.location.href = "/home/";
        }
      },
      error: function () {
        console.error("Auth check failed");
      }
    });


    // Toggle the cassette
    $("#AddRecordButton").on("click", function (e) {
      e.stopPropagation();

      const cassette = $("#collegeCodeCassette");
      cassette.toggleClass("show");

      if (cassette.hasClass("show")) {
        // Opening → focus but DO NOT clear
        $("#collegeCodeInput").focus();
      } else {
        // Closing → clear input
        $("#collegeCodeInput").val("");
      }
    });

    // Click outside closes cassette
    $(document).on("click", function (e) {
      if (!$(e.target).closest("#collegeCodeCassette, #AddRecordButton").length) {
        $("#collegeCodeCassette").removeClass("show");
        // Clear input when closed
        $("#collegeCodeInput").val("");
      }
    });

    // Prevent inner clicks from closing it
    $("#collegeCodeCassette").on("click", function (e) {
      e.stopPropagation();
    });

    // toggle collapsible discipline
    $(document).on("click", ".toggle-discipline", function () {
      const container = $(this).closest(".discipline-wrapper").find(".discipline-programs-container");
      container.slideToggle(200);

      const icon = $(this).find("i");
      icon.toggleClass("bi-chevron-down bi-chevron-up");
    });

    // ADD MODE - When user enters college code to add new records
    $("#submitCollegeCode").on("click", function () {
      const collegeCode = $("#collegeCodeInput").val().trim();

      if (!collegeCode) {
        showNotification("Please enter a college code", "danger");
        return;
      }

      $.ajax({
        url: "/get-college-data/",
        type: "GET",
        data: {
          college_code: collegeCode,
          mode: "add"
        },
        success: function (response) {
          if (response.status === 200 && response.mode === "add") {
            populateAddModal(response);
            $("#collegeModal").data("mode", "add");
            $("#collegeModal").modal("show");
          }
          else if (response.status === 409) {
            showNotification(response.message, "danger");
          }
          else {
            showNotification("Invalid college code", "danger");
          }
        },
        error: function () {
          showNotification("Server error", "danger");
        }
      });
    });


    $("#submitRecordForm").on("click", function () {
      const collegeCode = $("#collegeModal").data("college-code");
      const academicYear = $("#academicYear").val();
      const mode = $("#collegeModal").data("mode");

      if (!academicYear) {
        showNotification("Please select academic year", "danger");
        return;
      }

      // safe integer parser: returns 0 for empty/invalid
      function toInt(v) {
        const n = parseInt(v, 10);
        return Number.isFinite(n) ? n : 0;
      }

      let records = {};
      let failedValidation = null;

      $(".program-section").each(function () {
        let section = $(this);

        // VALIDATE THIS PROGRAM FIRST
        let check = validateProgramSection(section);
        if (!check.valid) {
          failedValidation = check.message;
          return false; // stop loop
        }

        let program = section.data("program") || section.find(".program-title").text().trim() || "program";

        // top-level totals/gender
        const total_students = toInt(section.find(".total-students").val());
        const gender = {
          male: toInt(section.find(".gender-male").val()),
          female: toInt(section.find(".gender-female").val()),
          others: toInt(section.find(".gender-others").val())
        };

        // categories (each with male/female/others)
        const catKeys = ["open", "obc", "sc", "st", "nt", "vjnt", "ews"];
        const category = {};
        catKeys.forEach(key => {
          category[key] = {
            male: toInt(section.find(`.cat-${key}-male`).val()),
            female: toInt(section.find(`.cat-${key}-female`).val()),
            others: toInt(section.find(`.cat-${key}-others`).val())
          };
        });

        // religion
        const relKeys = ["hindu", "muslim", "sikh", "christian", "jain", "buddhist", "other"];
        const religion = {};
        relKeys.forEach(key => {
          religion[key] = {
            male: toInt(section.find(`.rel-${key}-male`).val()),
            female: toInt(section.find(`.rel-${key}-female`).val()),
            others: toInt(section.find(`.rel-${key}-others`).val())
          };
        });

        // disability
        const disKeys = ["no_disability", "lowvision", "blindness", "hearing", "locomotor", "autism", "other"];
        const disability = {};
        disKeys.forEach(key => {
          disability[key] = {
            male: toInt(section.find(`.dis-${key}-male`).val()),
            female: toInt(section.find(`.dis-${key}-female`).val()),
            others: toInt(section.find(`.dis-${key}-others`).val())
          };
        });

        // assign
        records[program] = {
          total_students: total_students,
          gender: gender,
          category: category,
          religion: religion,
          disability: disability
        };
      });

      // IF ANY PROGRAM FAILED → STOP SUBMISSION
      if (failedValidation) {
        showNotification(failedValidation, "danger");
        return;
      }

      let payload = {
        college_code: collegeCode,
        academic_year: academicYear,
        records: records
      };
      console.log(records)

      // send (URLs unchanged as requested)
      if (mode === "add") {
        $.ajax({
          url: "/add_student/",
          type: "POST",
          data: JSON.stringify(payload),
          contentType: "application/json",
          success: function (response) {
            if (response.status === 200) {
              showNotification("Student records saved successfully!", "success");
              $("#collegeModal").modal("hide");
              table.ajax.reload(null, false);
            } else {
              showNotification(response.message || "Something went wrong", "danger");
            }
          },
          error: function () {
            showNotification("Server error", "danger");
          }
        });
      }
      else {
        // EDIT MODE
        $.ajax({
          url: "/edit_student/",
          type: "POST",
          data: JSON.stringify(payload),
          contentType: "application/json",
          success: function (response) {
            if (response.status === 200) {
              showNotification("Student records updated successfully!", "success");
              $("#collegeModal").modal("hide");
              table.ajax.reload(null, false);
            } else {
              showNotification(response.message || "Something went wrong", "danger");
            }
          },
          error: function () {
            showNotification("Server error", "danger");
          }
        });
      }
    });



    $("#logout_btn").on("click", function (e) {
      e.preventDefault();
      $.ajax({
        url: "{% url 'logout' %}",
        type: "POST",
        success: function (data) {
          if (data.status === 200) {
            window.location.href = "/home/";
          }
        },
        error: function () {
          alert("Logout failed. Try again.");
        }
      });
    });

    // Export Student Excel
    $(document).on("click", "#ExportStudentExcelButton", function () {
      const year = $("#globalAcademicYear").val();

      if (!year) {
        showNotification("Please select an academic year first", "danger");
        return;
      }

      // Direct download request
      window.location.href = "/export-student-excel/?year=" + encodeURIComponent(year);
    });

  })

  let selectedYear = $("#globalAcademicYear").val();

  const table = $("#records_table").DataTable({
    serverSide: true,
    processing: true,
    ajax: {
      url: "/get-student-records/",
      type: "GET",
      data: function (d) {
        d.year = selectedYear;
      }
    },
    pageLength: 10,
    columns: [
      {
        data: null,
        orderable: false,
        searchable: false,
        render: function () {
          return `
                        <button class="btn btn-sm btn-outline-primary toggle-programs">
                            <i class="bi bi-plus-lg"></i>
                        </button>`;
        }
      },
      { data: "college_code" },
      { data: "college_name" },
      { data: "academic_year" },
      {
        data: "total_students",
        render: (d) => d ?? "-"
      },
      {
        data: null,
        render: function (data, type, row) {
          const tpl = document.querySelector("#actionButtonsTemplate");
          const clone = tpl.content.cloneNode(true);

          // set edit attributes
          clone.querySelector(".btn-edit").setAttribute("data-college", row.college_code);
          clone.querySelector(".btn-edit").setAttribute("data-year", row.academic_year);

          // set delete handler
          clone.querySelector(".btn-delete").setAttribute("data-college", row.college_code);
          clone.querySelector(".btn-delete").setAttribute("data-year", row.academic_year);


          return $("<div>").append(clone).html();
        }
      }
    ],
    order: [[2, "asc"]]
  });

  //  YEAR CHANGE → RELOAD TABLE

  $("#globalAcademicYear").on("change", function () {
    selectedYear = $(this).val();
    table.ajax.reload();
  });

  //  LABEL MAP FOR FULL DESCRIPTIONS
  const LABEL_MAP = {
    // Gender
    male: "Male",
    female: "Female",
    others: "Others",

    // Category
    open: "Open",
    obc: "OBC",
    sc: "SC",
    st: "ST",
    nt: "NT",
    vjnt: "VJNT",
    ews: "EWS",

    // Religion
    hindu: "Hindu",
    muslim: "Muslim",
    sikh: "Sikh",
    christian: "Christian",
    jain: "Jain",
    buddhist: "Buddhist",
    other: "Other Religions",

    // Disability
    no_disability: "No Disability",
    lowvision: "Low Vision",
    blindness: "Blindness",
    hearing: "Hearing Impaired",
    locomotor: "Locomotor Disability",
    autism: "Autism",
    other_disability: "Other Disabilities"
  };

  // BUILD FULL PROGRAM ACCORDION USING TEMPLATES
  function formatPrograms(row) {
    const wrapper = document.createElement("div");
    wrapper.className = "dt-child-scroll";

    const container = document.createElement("div");
    container.className = "container-fluid p-0";

    const inner = document.createElement("div");
    inner.className = "py-3";

    // Main accordion container
    const accordion = document.createElement("div");
    accordion.className = "accordion";
    accordion.id = `acc-${row.college_code}`;

    // row.programs = [{ discipline: "", programs: [ ... ] }]
    row.programs.forEach((group, groupIndex) => {

      // ---------------------------
      // Discipline Header (inside accordion)
      // ---------------------------
      const discHeader = document.createElement("div");
      discHeader.className = "discipline-header-row";

      const discText = document.createElement("span");
      discText.className = "discipline-header-text";
      discText.textContent = group.discipline;

      discHeader.appendChild(discText);
      accordion.appendChild(discHeader);

      // Divider for proper top border before first program
      const divider = document.createElement("div");
      divider.className = "discipline-divider";
      accordion.appendChild(divider);


      // ---------------------------
      // Programs inside this discipline
      // ---------------------------
      group.programs.forEach((p, i) => {
        const tplItem = document.querySelector("#programAccordionTemplate");
        const acc = tplItem.content.cloneNode(true);

        const btn = acc.querySelector(".accordion-button");
        btn.textContent = `${p.name} (${p.total_students} students)`;
        btn.setAttribute("data-bs-toggle", "collapse");
        btn.setAttribute("data-bs-target", `#collapse-${row.college_code}-${groupIndex}-${i}`);

        const collapse = acc.querySelector(".accordion-collapse");
        collapse.id = `collapse-${row.college_code}-${groupIndex}-${i}`;
        collapse.setAttribute("data-bs-parent", `#acc-${row.college_code}`);

        const rowContainer = acc.querySelector(".program-content-row");

        // ---- TOTAL CARD ----
        const tplTotal = document.querySelector("#totalCardTemplate");
        const totalClone = tplTotal.content.cloneNode(true);
        totalClone.querySelector(".total-value").textContent = p.total_students;
        rowContainer.appendChild(totalClone);

        // ---- METRICS ----
        const metricGroups = {
          "Gender": { color: "bg-primary", data: p.gender },
          "Category (M/F/O)": { color: "bg-success", data: p.category },
          "Religion (M/F/O)": { color: "bg-warning text-dark", data: p.religion },
          "Disability (M/F/O)": { color: "bg-danger", data: p.disability }
        };

        Object.entries(metricGroups).forEach(([title, meta]) => {
          const tplMetric = document.querySelector("#metricCardTemplate");
          const clone = tplMetric.content.cloneNode(true);

          const titleEl = clone.querySelector(".metric-title");
          titleEl.textContent = title;
          titleEl.classList.add(...meta.color.split(" "));

          const tbody = clone.querySelector(".metric-body");

          // NEW: handle nested {male,female,others} objects
          Object.entries(meta.data).forEach(([label, value]) => {
            const tr = document.createElement("tr");

            let displayValue;

            // if it's an object with male/female/others, format as "M/F/O"
            if (value && typeof value === "object" && ("male" in value || "female" in value || "others" in value)) {
              const m = Number.isFinite(Number(value.male)) ? Number(value.male) : 0;
              const f = Number.isFinite(Number(value.female)) ? Number(value.female) : 0;
              const o = Number.isFinite(Number(value.others)) ? Number(value.others) : 0;
              displayValue = `${m}/${f}/${o}`;
            } else {
              // fallback: plain number or string (backwards compatibility)
              displayValue = (value === null || value === undefined || value === "") ? "-" : value;
            }

            tr.innerHTML = `
                    <td>${LABEL_MAP[label] || label}</td>
                    <td>${displayValue}</td>
                `;
            tbody.appendChild(tr);
          });

          rowContainer.appendChild(clone);
        });

        accordion.appendChild(acc);
      });
    });

    inner.appendChild(accordion);
    container.appendChild(inner);
    wrapper.appendChild(container);

    return wrapper.outerHTML;
  }


  //  EXPAND / COLLAPSE CHILD ROWS
  $("#records_table tbody").on("click", ".toggle-programs", function () {

    const tr = $(this).closest("tr");
    const row = table.row(tr);
    const btn = $(this);

    if (row.child.isShown()) {
      row.child.hide();
      btn.html('<i class="bi bi-plus-lg"></i>');
    } else {
      row.child(formatPrograms(row.data())).show();
      btn.html('<i class="bi bi-dash-lg"></i>');
    }
  });


  // EDIT MODE - When user clicks on "Edit"
  $(document).on("click", ".btn-edit", function (e) {
    e.preventDefault();

    const college = $(this).data("college");
    const year = $(this).data("year") || $("#globalAcademicYear").val();

    if (!college) {
      showNotification("Missing college code", "danger");
      return;
    }

    const $btn = $(this);
    $btn.prop("disabled", true).addClass("disabled");

    $.ajax({
      // 👇 revert to the original endpoint with hyphens
      url: "/get-college-data/",
      type: "GET",
      data: {
        college_code: college,
        academic_year: year,
        mode: "edit"
      },
      success: function (response) {
        $btn.prop("disabled", false).removeClass("disabled");

        if (response && response.status === 200) {
          populateEditModal(response);

          $("#collegeModal").data("mode", "edit");
          $("#collegeModal").data("college-code", response.college_data?.College_Code || college);

          $("#collegeModal").modal("show");
        } else {
          showNotification(response?.message || "Unable to load records", "danger");
        }
      },
      error: function (xhr) {
        $btn.prop("disabled", false).removeClass("disabled");
        let msg = "Server error";
        try {
          const json = JSON.parse(xhr.responseText);
          if (json && json.message) msg = json.message;
        } catch (e) { }
        showNotification(msg, "danger");
      }
    });
  });



  // DELETE RECORD HANDLER 
  $(document).on("click", ".btn-delete", function () {
    const college = $(this).data("college");
    console.log(college);
    const year = $(this).data("year");
    console.log(year);

    if (!college || !year) {
      showNotification("Invalid record selected.", "danger");
      return;
    }

    // Confirm deletion
    if (!confirm(`Delete records for ${college} (${year})?`)) {
      return;
    }

    $.ajax({
      url: "/delete-student-record/",
      type: "POST",
      data: {
        college_code: college,
        academic_year: year
      },
      success: function (response) {
        if (response.status === 204) {
          showNotification("Record deleted successfully.", "success");
          $("#records_table").DataTable().ajax.reload(null, false);
        } else {
          showNotification(response.message || "Delete failed", "danger");
        }
      },
      error: function () {
        showNotification("Server error", "danger");
      }
    });
  });



  function showNotification(message, type) {
    var notificationClass = type === "success" ? "notification-success" : "notification-error";
    var notification = $('<div>', {
      class: 'notification ' + notificationClass,
      text: message
    });

    $('body').append(notification);

    setTimeout(function () {
      notification.addClass('show-notification');
    }, 10); // slight delay to ensure the element is in the DOM

    setTimeout(function () {
      notification.removeClass('show-notification');
      setTimeout(function () {
        notification.remove();
      }, 500); // additional delay to allow transition effect
    }, 3000);
  }

</script>

</html>