<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- jQuery + Validation -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/jquery.validation/1.16.0/jquery.validate.min.js"></script>
  <script src="https://cdn.jsdelivr.net/jquery.validation/1.16.0/additional-methods.min.js"></script>

  <!-- DataTables -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

  <!-- Buttons CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">

  <!-- Buttons + dependencies for excel and print button -->
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>


  <title>Student Records</title>

  <style>
    /* Validation */
    label.error {
      color: #dc3545;
      font-size: 0.9rem;
    }


    body {
      background: #f8f9fa;
      font-family: "Segoe UI", Roboto, sans-serif;
      caret-color: transparent;
      margin: 0;
      padding: 0;
      height: 100%;
      overflow-x: hidden;
      overflow-y: hidden;
    }


    .modal-body {
      caret-color: auto;
      max-height: 88vh;
      overflow-y: auto;
    }


    /* Header */
    .header-container {
      margin-top: 0.5rem;
    }


    .header-banner {
      background: linear-gradient(135deg, #0d6efd, #198754);
      color: white;
      border-radius: 1rem;
      padding: 2.5rem 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }


    /* Table */
    .table-container {
      background: white;
      border-radius: 1rem;
      padding: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }


    table.dataTable thead {
      background: #0d6efd;
      color: white;
    }

    .notification {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px 30px;
      font-size: 1rem;
      font-weight: bold;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      opacity: 0;
      transition: opacity 0.5s ease-out, transform 0.5s ease-out;
      z-index: 2000;
    }

    .notification-success {
      background-color: #28a745;
      color: white;
    }

    .notification-error {
      background-color: #dc3545;
      color: white;
    }

    .show-notification {
      opacity: 1;
      transform: translateX(-50%) translateY(20px);
    }

    /* Collapsible cassette container (hidden by default) */
    #collegeCodeCassette {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-top: 1rem;
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transition: max-height .35s ease, opacity .3s ease;
    }

    /* Inner slim card */
    #collegeCodeCassette .inner-cassette {
      background: white;
      padding: .6rem .9rem;
      border-radius: .75rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, .08);
      border: 1px solid rgba(0, 0, 0, 0.08);
      width: auto;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem
    }


    /* Show state */
    #collegeCodeCassette.show {
      max-height: 90px;
      opacity: 1;
    }

    /* Input styling refined */
    #collegeCodeInput {
      text-align: center;
      background: #f8f9fa;
      border: 1px solid rgba(0, 0, 0, 0.1);
      width: 140px;
    }

    #collegeCodeInput:focus {
      background: #fff;
      border-color: #0d6efd;
      box-shadow: 0 0 0 0.15rem rgba(13, 110, 253, .15);
    }
  </style>
</head>

<body>
  <!-- Student Records -->
  <div class="container-fluid">
    <div class="row">
      <div class="col-lg-12 mx-auto">
        <div class="header-container text-center">
          <div class="header-banner position-relative">
            <div class="position-absolute top-0 end-0 p-3 text-end">

              <!-- Welcome Text -->
              <span id="welcome_msg" class="text-light fw-semibold d-block mb-1">
                Welcome, {{ request.user.username }}
              </span>

              <!-- Logout Button -->
              <button id="logout_btn" class="btn btn-outline-light btn-sm logout-btn">
                <i class="bi bi-box-arrow-right"></i> Logout
              </button>

            </div>


            <h1 class="fw-bold">Student Records</h1>
            <p>Add your student record here</p>
            <button type="button" class="btn btn-success btn-lg shadow-sm" id="AddRecordButton">
              <i class="bi bi-plus-lg"></i> Add Record
            </button>

            <!-- Cascading Input Cassette -->

            <div id="collegeCodeCassette" class="cassette">
              <div class="inner-cassette d-flex align-items-center gap-2">
                <input type="text" id="collegeCodeInput" class="form-control form-control-sm" placeholder="College code"
                  inputmode="numeric">
                <button class="btn btn-primary btn-sm" id="submitCollegeCode">Submit</button>
              </div>
            </div>


          </div>


          <div class="table-container" id="datatable_wrapper">
            <table class="table table-hover align-middle" id="records_table">
              <thead>
                <tr>
                  <!-- add column names here -->
                </tr>
              </thead>
            </table>
          </div>

        </div>
      </div>
    </div>


    <!-- Add Student Records Modal -->
    <div class="modal fade" id="collegeModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">

          <div class="modal-header">
            <div>
              <h2 class="fw-bold mb-0" id="modalCollegeName"></h2>
              <small class="text-muted" id="modalCollegeAddress"></small>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">

            <!-- Academic Year -->
            <div class="col-md-4">
              <label class="fw-semibold">Academic Year</label>
              <select id="academicYear" class="form-select">
                <option value="">Select Year</option>
                {% for year in academic_year %}
                <option value="{{ year.Academic_Year }}">{{ year.Academic_Year }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Dynamic Program Sections Will Appear Here -->
            <div id="programSectionsContainer"></div>

          </div>

          <div class="modal-footer">
            <button class="btn btn-success" id="submitRecordForm">Submit Records</button>
          </div>

        </div>
      </div>
    </div>


    <template id="programTemplate">
      <div class="program-section">

        <hr>
        <h4 class="fw-bold mt-3 program-title"></h4>

        <!-- TOTAL STUDENTS -->
        <div class="row mt-2">
          <div class="col-md-4">
            <label class="fw-semibold">Total Students</label>
            <input type="number" class="form-control total-students">
          </div>
        </div>

        <!-- GENDER COUNT -->
        <h6 class="mt-3">Gender Count</h6>
        <div class="row">
          <div class="col-md-3">
            <label>Male</label>
            <input type="number" class="form-control gender-male" min="0">
          </div>
          <div class="col-md-3">
            <label>Female</label>
            <input type="number" class="form-control gender-female" min="0">
          </div>
           <div class="col-md-3">
            <label>Others</label>
            <input type="number" class="form-control gender-others" min="0">
          </div>
        </div>

        <!-- CATEGORY COUNT -->
        <h6 class="mt-3">Category Count</h6>
        <div class="row">
          <div class="col-md-3"><label>OPEN</label><input type="number" class="form-control cat-open"></div>
          <div class="col-md-3"><label>OBC</label><input type="number" class="form-control cat-obc"></div>
          <div class="col-md-3"><label>SC</label><input type="number" class="form-control cat-sc"></div>
          <div class="col-md-3"><label>ST</label><input type="number" class="form-control cat-st"></div>
        </div>

        <div class="row mt-2">
          <div class="col-md-3"><label>NT</label><input type="number" class="form-control cat-nt"></div>
          <div class="col-md-3"><label>VJNT</label><input type="number" class="form-control cat-vjnt"></div>
          <div class="col-md-3"><label>EWS</label><input type="number" class="form-control cat-ews"></div>
        </div>

        <!-- RELIGION COUNT -->
        <h6 class="mt-3">Religion Count</h6>
        <div class="row">
          <div class="col-md-3"><label>Hindu</label><input type="number" class="form-control rel-hindu"></div>
          <div class="col-md-3"><label>Muslim</label><input type="number" class="form-control rel-muslim"></div>
          <div class="col-md-3"><label>Sikh</label><input type="number" class="form-control rel-sikh"></div>
          <div class="col-md-3"><label>Christian</label><input type="number" class="form-control rel-christian"></div>
        </div>

        <div class="row mt-2">
          <div class="col-md-3"><label>Jain</label><input type="number" class="form-control rel-jain"></div>
          <div class="col-md-3"><label>Buddhist</label><input type="number" class="form-control rel-buddhist"></div>
          <div class="col-md-3"><label>Other</label><input type="number" class="form-control rel-other"></div>
        </div>

        <!-- DISABILITY COUNT -->
        <h6 class="mt-3">Disability Count</h6>
        <div class="row">
          <div class="col-md-3"><label>None</label><input type="number" class="form-control dis-none"></div>
          <div class="col-md-3"><label>Low Vision</label><input type="number" class="form-control dis-lowvision"></div>
          <div class="col-md-3"><label>Blindness</label><input type="number" class="form-control dis-blindness"></div>
          <div class="col-md-3"><label>Hearing Impaired</label><input type="number" class="form-control dis-hearing">
          </div>
        </div>

        <div class="row mt-2">
          <div class="col-md-3"><label>Locomotor Disability</label><input type="number"
              class="form-control dis-locomotor">
          </div>
          <div class="col-md-3"><label>Autism</label><input type="number" class="form-control dis-autism"></div>
          <div class="col-md-3"><label>Other</label><input type="number" class="form-control dis-other"></div>
        </div>

      </div>
    </template>

</body>

<script>
  // function to get CSRF cookie
  function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      var cookies = document.cookie.split(';');
      $.each(cookies, function (i, cookie) {
        cookie = $.trim(cookie);
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          return false; // break loop
        }
      });
    }
    return cookieValue;
  }

  // jQuery global setup: adds CSRF to every non-GET request
  $.ajaxSetup({
    beforeSend: function (xhr, settings) {
      if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type)) {
        xhr.setRequestHeader("X-CSRFToken", getCookie("csrftoken"));
      }
    },
    complete: function (xhr) {
      if (xhr.responseJSON && xhr.responseJSON.status === 302) {
        // Session expired or forbidden
        showNotification("Session expired. Please log in again.", "danger");
        window.location.href = "/home/";
      }
    }
  });

  function populateCollegeModal(data) {

    $("#modalCollegeName").text(data.college_data.College_Name);
    $("#modalCollegeAddress").text(data.college_data.address + ", " +
      data.college_data.Taluka + ", " + data.college_data.District + " - " + data.college_data.pincode);

    // Clear previous items
    $("#programSectionsContainer").empty();
    console.log("Adding program sections:", data.college_data.programs);
    data.college_data.programs.forEach(program => {
      addProgramSection(program);
    });

    // Store college code for submit
    $("#collegeModal").data("college-code", data.college_data.College_Code);
  }


  function addProgramSection(programName) {

    const template = document.querySelector("#programTemplate");
    const clone = template.content.cloneNode(true);

    clone.querySelector(".program-title").innerText = programName;
    clone.querySelector(".program-section").dataset.program = programName;

    document.querySelector("#programSectionsContainer").appendChild(clone);
  }

  function validateProgramSection(section) {

    let programName = section.data("program");
    let total = parseInt(section.find(".total-students").val()) || 0;

    if (!total || total <= 0) {
      return {
        valid: false,
        message: `${programName}: Total Students is required and must be greater than 0.`
      };
    }

    function sumFields(selector) {
      let sum = 0;
      section.find(selector).each(function () {
        let val = parseInt($(this).val()) || 0;
        sum += val;
      });
      return sum;
    }

    // Calculate aggregates
    let genderSum = sumFields(".gender-male, .gender-female, .gender-others");
    let categorySum = sumFields(".cat-open, .cat-obc, .cat-sc, .cat-st, .cat-nt, .cat-vjnt, .cat-ews");
    let religionSum = sumFields(".rel-hindu, .rel-muslim, .rel-sikh, .rel-christian, .rel-jain, .rel-buddhist, .rel-other");
    let disabilitySum = sumFields(".dis-none, .dis-lowvision, .dis-blindness, .dis-hearing, .dis-locomotor, .dis-autism, .dis-other");

    // Validate each
    if (genderSum !== total) {
      return {
        valid: false,
        message: `${programName}: Gender total (${genderSum}) does not match Total Students (${total}).`
      };
    }
    if (categorySum !== total) {
      return {
        valid: false,
        message: `${programName}: Category total (${categorySum}) does not match Total Students (${total}).`
      };
    }
    if (religionSum !== total) {
      return {
        valid: false,
        message: `${programName}: Religion total (${religionSum}) does not match Total Students (${total}).`
      };
    }
    if (disabilitySum !== total) {
      return {
        valid: false,
        message: `${programName}: Disability total (${disabilitySum}) does not match Total Students (${total}).`
      };
    }

    return { valid: true };
  }



  $('document').ready(function () {

    $.ajax({
      url: "{% url 'user_status' %}", // backend endpoint for checking auth
      type: "GET",
      success: function (response) {
        if (response.status === 200) {
          // add datatable initialization
        } else {
          window.location.href = "/home/";
        }
      },
      error: function () {
        console.error("Auth check failed");
      }
    });


    // Toggle the cassette
    $("#AddRecordButton").on("click", function (e) {
      e.stopPropagation();
      $("#collegeCodeCassette").toggleClass("show");

      if ($("#collegeCodeCassette").hasClass("show")) {
        $("#collegeCodeInput").focus();
      }
    });

    // Click outside closes cassette
    $(document).on("click", function (e) {
      if (!$(e.target).closest("#collegeCodeCassette, #AddRecordButton").length) {
        $("#collegeCodeCassette").removeClass("show");
      }
    });

    // Prevent inner clicks from closing it
    $("#collegeCodeCassette").on("click", function (e) {
      e.stopPropagation();
    });

    // from here starts the adding record logic 
    $("#submitCollegeCode").on("click", function () {
      const collegeCode = $("#collegeCodeInput").val().trim();
      console.log("Submitting college code:", collegeCode);

      if (!collegeCode) {
        showNotification("Please enter a college code", "danger");
        return;
      }

      $.ajax({
        url: "/get-college-data/",
        type: "GET",
        data: { college_code: collegeCode },
        success: function (response) {
          if (response.status === 200) {
            console.log("College data received:", response);
            populateCollegeModal(response);
            $("#collegeModal").modal("show");
          }
          else if (response.status === 409) {
            showNotification(response.message, "danger");
          } else {
            showNotification("Invalid college code", "danger");
          }
        },
        error: function () {
          showNotification("Server error", "danger");
        }
      });
    });


    $("#submitRecordForm").on("click", function () {
      const collegeCode = $("#collegeModal").data("college-code");
      const academicYear = $("#academicYear").val();

      if (!academicYear) {
        showNotification("Please select academic year", "danger");
        return;
      }

      let records = {};
      let failedValidation = null;

      $(".program-section").each(function () {

        let section = $(this);

        // VALIDATE THIS PROGRAM FIRST
        let check = validateProgramSection(section);
        if (!check.valid) {
          failedValidation = check.message;
          return false; // stop loop
        }

        let program = section.data("program");

        records[program] = {

          total_students: section.find(".total-students").val(),

          gender: {
            male: section.find(".gender-male").val(),
            female: section.find(".gender-female").val(),
            others: section.find(".gender-others").val(),
          },

          category: {
            open: section.find(".cat-open").val(),
            obc: section.find(".cat-obc").val(),
            sc: section.find(".cat-sc").val(),
            st: section.find(".cat-st").val(),
            nt: section.find(".cat-nt").val(),
            vjnt: section.find(".cat-vjnt").val(),
            ews: section.find(".cat-ews").val(),
          },

          religion: {
            hindu: section.find(".rel-hindu").val(),
            muslim: section.find(".rel-muslim").val(),
            sikh: section.find(".rel-sikh").val(),
            christian: section.find(".rel-christian").val(),
            jain: section.find(".rel-jain").val(),
            buddhist: section.find(".rel-buddhist").val(),
            other: section.find(".rel-other").val(),
          },

          disability: {
            none: section.find(".dis-none").val(),
            lowvision: section.find(".dis-lowvision").val(),
            blindness: section.find(".dis-blindness").val(),
            hearing: section.find(".dis-hearing").val(),
            locomotor: section.find(".dis-locomotor").val(),
            autism: section.find(".dis-autism").val(),
            other: section.find(".dis-other").val(),
          }
        };
      });

      // IF ANY PROGRAM FAILED â†’ STOP SUBMISSION
      if (failedValidation) {
        showNotification(failedValidation, "danger");
        return;
      }

      let payload = {
        college_code: collegeCode,
        academic_year: academicYear,
        records: records
      };

      console.log("Sending payload to backend...");
      console.log(payload);

      $.ajax({
        url: "/submit-student-records/",
        type: "POST",
        data: JSON.stringify(payload),
        contentType: "application/json",
        success: function (response) {
          if (response.status === 200) {
            showNotification("Student records saved successfully!", "success");
            $("#collegeModal").modal("hide");
          } else {
            showNotification(response.message || "Something went wrong", "danger");
          }
        },
        error: function () {
          showNotification("Server error", "danger");
        }
      });
    });



    $("#logout_btn").on("click", function (e) {
      e.preventDefault();
      $.ajax({
        url: "{% url 'logout' %}",
        type: "POST",
        success: function (data) {
          if (data.status === 200) {
            window.location.href = "/home/";
          }
        },
        error: function () {
          alert("Logout failed. Try again.");
        }
      });
    });
  })


  function showNotification(message, type) {
    var notificationClass = type === "success" ? "notification-success" : "notification-error";
    var notification = $('<div>', {
      class: 'notification ' + notificationClass,
      text: message
    });

    $('body').append(notification);

    setTimeout(function () {
      notification.addClass('show-notification');
    }, 10); // slight delay to ensure the element is in the DOM

    setTimeout(function () {
      notification.removeClass('show-notification');
      setTimeout(function () {
        notification.remove();
      }, 500); // additional delay to allow transition effect
    }, 3000);
  }

</script>

</html>