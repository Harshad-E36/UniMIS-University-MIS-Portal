<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- jQuery + Validation -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/jquery.validation/1.16.0/jquery.validate.min.js"></script>
  <script src="https://cdn.jsdelivr.net/jquery.validation/1.16.0/additional-methods.min.js"></script>

  <!-- DataTables -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

  <!-- Buttons CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">

  <!-- Buttons + dependencies for excel and print button -->
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>


  <title>Student Records</title>

  <style>
    /* Validation */
    label.error {
      color: #dc3545;
      font-size: 0.9rem;
    }

    body {
      background: #f8f9fa;
      font-family: "Segoe UI", Roboto, sans-serif;
      caret-color: transparent;
      margin: 0;
      padding: 0;
      height: 100%;
      overflow-x: hidden;
      overflow-y: auto;
      /* IMPORTANT */
    }

    /* Modal scroll fixes */
    .modal-dialog {
      max-width: 90%;
      margin: 1.5rem auto;
    }

    .modal-content {
      max-height: 95vh;
      overflow: hidden;
    }

    .modal-body {
      caret-color: auto;
      overflow-y: auto;
      max-height: calc(95vh - 120px);
      /* Fix overflow */
      padding-right: 15px;
    }

    /* Header */
    .header-container {
      margin-top: 0.5rem;
    }

    .header-banner {
      background: linear-gradient(135deg, #0d6efd, #198754);
      color: white;
      border-radius: 1rem;
      padding: 2.5rem 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }


    /* Table */
    .table-container {
      background: white;
      border-radius: 1rem;
      padding: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    table.dataTable thead {
      background: #0d6efd;
      color: white;
    }
    table.dataTable thead th {
      text-align: center;
      vertical-align: middle;
    }

    /* Notification styles */
    .notification {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px 30px;
      font-size: 1rem;
      font-weight: bold;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      opacity: 0;
      transition: opacity 0.5s ease-out, transform 0.5s ease-out;
      z-index: 2000;
    }

    .notification-success {
      background-color: #28a745;
      color: white;
    }

    .notification-error {
      background-color: #dc3545;
      color: white;
    }

    .show-notification {
      opacity: 1;
      transform: translateX(-50%) translateY(20px);
    }

    /* College code cassette */
    #collegeCodeCassette {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-top: 1rem;
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transition: max-height .35s ease, opacity .3s ease;
    }

    #collegeCodeCassette .inner-cassette {
      background: white;
      padding: .6rem .9rem;
      border-radius: .75rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, .08);
      border: 1px solid rgba(0, 0, 0, 0.08);
      width: auto;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    #collegeCodeCassette.show {
      max-height: 90px;
      opacity: 1;
    }

    #collegeCodeInput {
      text-align: center;
      background: #f8f9fa;
      border: 1px solid rgba(0, 0, 0, 0.1);
      width: 140px;
    }

    #collegeCodeInput:focus {
      background: #fff;
      border-color: #0d6efd;
      box-shadow: 0 0 0 0.15rem rgba(13, 110, 253, .15);
    }

    /* Fix right white space in DataTables child accordion */
    .dt-child-scroll .row {
      margin-left: 0 !important;
      margin-right: 0 !important;
    }

    /* Ensure accordion inside DataTable row uses 100% width */
    .dt-child-scroll .accordion-item,
    .dt-child-scroll .accordion-button,
    .dt-child-scroll .accordion-body,
    .dt-child-scroll .container-fluid,
    .dt-child-scroll .row {
      width: 100% !important;
      max-width: 100% !important;
      overflow-x: hidden;
    }
  </style>
</head>

<body>
  <!-- Student Records -->
  <div class="container-fluid">
    <div class="row">
      <div class="col-lg-12 mx-auto">
        <div class="header-container text-center">
          <div class="header-banner position-relative">
            <div class="position-absolute top-0 end-0 p-3 text-end">
              <!-- Welcome Text -->
              <span id="welcome_msg" class="text-light fw-semibold d-block mb-1">
                Welcome, {{ request.user.username }}
              </span>

              <!-- TOP ROW: Logout + Export -->
              <div class="d-flex justify-content-end align-items-center gap-2 mb-2">

                <!-- Logout -->
                <button id="logout_btn" class="btn btn-outline-light btn-sm logout-btn">
                  <i class="bi bi-box-arrow-right"></i> Logout
                </button>

                <!-- Export Excel (small button) -->
                <button type="button" class="btn btn-warning btn-sm shadow-sm" id="ExportStudentExcelButton">
                  <i class="bi bi-file-earmark-excel"></i>
                  Export to Excel
                </button>

              </div>

              <!-- BOTTOM ROW: Academic Year -->
              <div class="d-flex justify-content-end align-items-center mt-1">

                <div class="text-light small me-2 fw-semibold">Academic Year</div>

                <select id="globalAcademicYear" class="form-select form-select-sm" style="width: 110px;">
                  {% for year in academic_year %}
                  <option value="{{ year.Academic_Year }}">{{ year.Academic_Year }}</option>
                  {% endfor %}
                </select>

              </div>

            </div>



            <h1 class="fw-bold">Student Records</h1>
            <p>Add your student record here</p>
            <button type="button" class="btn btn-success btn-lg shadow-sm" id="AddRecordButton">
              <i class="bi bi-plus-lg"></i> Add Record
            </button>

            <!-- Cascading Input Cassette -->

            <div id="collegeCodeCassette" class="cassette">
              <div class="inner-cassette d-flex align-items-center gap-2">
                <input type="text" id="collegeCodeInput" class="form-control form-control-sm" placeholder="College code"
                  inputmode="numeric">
                <button class="btn btn-primary btn-sm" id="submitCollegeCode">Submit</button>
              </div>
            </div>


          </div>


          <div class="table-container" id="datatable_wrapper">
            <table id="records_table" class="table table-hover align-middle" width="100%">
              <thead>
                <tr>
                  <th>Action</th>
                  <th>College Code</th>
                  <th>College Name</th>
                  <th>Academic Year</th>
                  <th>Total Students</th>
                  <th>Edit/Delete</th>
                </tr>
              </thead>
            </table>

          </div>

        </div>
      </div>
    </div>


    <!-- Add Student Records Modal -->
    <div class="modal fade" id="collegeModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">

          <div class="modal-header">
            <div>
              <h2 class="fw-bold mb-0" id="modalCollegeName"></h2>
              <small class="text-muted" id="modalCollegeAddress"></small>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">

            <!-- Academic Year -->
            <div class="col-md-4">
              <label class="fw-semibold">Academic Year</label>
              <select id="academicYear" class="form-select">
                <option value="">Select Year</option>
                {% for year in academic_year %}
                <option value="{{ year.Academic_Year }}">{{ year.Academic_Year }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Dynamic Program Sections Will Appear Here -->
            <div id="programSectionsContainer"></div>

          </div>

          <div class="modal-footer">
            <button class="btn btn-success" id="submitRecordForm">Submit Records</button>
          </div>

        </div>
      </div>
    </div>


    <template id="programTemplate">
      <div class="program-section">

        <hr>
        <h4 class="fw-bold mt-3 program-title"></h4>

        <!-- TOTAL STUDENTS -->
        <div class="row mt-2">
          <div class="col-md-4">
            <label class="fw-semibold">Total Students</label>
            <input type="number" class="form-control total-students">
          </div>
        </div>

        <!-- GENDER COUNT -->
        <h6 class="mt-3">Gender Count</h6>
        <div class="row">
          <div class="col-md-3">
            <label>Male</label>
            <input type="number" class="form-control gender-male" min="0">
          </div>
          <div class="col-md-3">
            <label>Female</label>
            <input type="number" class="form-control gender-female" min="0">
          </div>
          <div class="col-md-3">
            <label>Others</label>
            <input type="number" class="form-control gender-others" min="0">
          </div>
        </div>

        <!-- CATEGORY COUNT -->
        <h6 class="mt-3">Category Count</h6>
        <div class="row">
          <div class="col-md-3"><label>OPEN</label><input type="number" class="form-control cat-open"></div>
          <div class="col-md-3"><label>OBC</label><input type="number" class="form-control cat-obc"></div>
          <div class="col-md-3"><label>SC</label><input type="number" class="form-control cat-sc"></div>
          <div class="col-md-3"><label>ST</label><input type="number" class="form-control cat-st"></div>
        </div>

        <div class="row mt-2">
          <div class="col-md-3"><label>NT</label><input type="number" class="form-control cat-nt"></div>
          <div class="col-md-3"><label>VJNT</label><input type="number" class="form-control cat-vjnt"></div>
          <div class="col-md-3"><label>EWS</label><input type="number" class="form-control cat-ews"></div>
        </div>

        <!-- RELIGION COUNT -->
        <h6 class="mt-3">Religion Count</h6>
        <div class="row">
          <div class="col-md-3"><label>Hindu</label><input type="number" class="form-control rel-hindu"></div>
          <div class="col-md-3"><label>Muslim</label><input type="number" class="form-control rel-muslim"></div>
          <div class="col-md-3"><label>Sikh</label><input type="number" class="form-control rel-sikh"></div>
          <div class="col-md-3"><label>Christian</label><input type="number" class="form-control rel-christian"></div>
        </div>

        <div class="row mt-2">
          <div class="col-md-3"><label>Jain</label><input type="number" class="form-control rel-jain"></div>
          <div class="col-md-3"><label>Buddhist</label><input type="number" class="form-control rel-buddhist"></div>
          <div class="col-md-3"><label>Other</label><input type="number" class="form-control rel-other"></div>
        </div>

        <!-- DISABILITY COUNT -->
        <h6 class="mt-3">Disability Count</h6>
        <div class="row">
          <div class="col-md-3"><label>None</label><input type="number" class="form-control dis-none"></div>
          <div class="col-md-3"><label>Low Vision</label><input type="number" class="form-control dis-lowvision"></div>
          <div class="col-md-3"><label>Blindness</label><input type="number" class="form-control dis-blindness"></div>
          <div class="col-md-3"><label>Hearing Impaired</label><input type="number" class="form-control dis-hearing">
          </div>
        </div>

        <div class="row mt-2">
          <div class="col-md-3"><label>Locomotor Disability</label><input type="number"
              class="form-control dis-locomotor">
          </div>
          <div class="col-md-3"><label>Autism</label><input type="number" class="form-control dis-autism"></div>
          <div class="col-md-3"><label>Other</label><input type="number" class="form-control dis-other"></div>
        </div>

      </div>
    </template>

    <template id="programAccordionTemplate">
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button"></button>
        </h2>

        <div class="accordion-collapse collapse">
          <div class="accordion-body">
            <div class="row program-content-row"></div>
          </div>
        </div>
      </div>
    </template>

    <template id="metricCardTemplate">
      <div class="col-md-2 mb-3 metric-col">
        <div class="card shadow-sm">
          <div class="card-header text-white py-2 text-center fw-bold metric-title"></div>
          <div class="card-body p-2">
            <table class="table table-sm mb-0">
              <tbody class="metric-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </template>

    <template id="totalCardTemplate">
      <div class="col-md-2 mb-3">
        <div class="card shadow-sm">
          <div class="card-header bg-secondary text-white py-2 text-center fw-bold">Total</div>
          <div class="card-body p-2">
            <h4 class="text-center fw-bold mb-0 total-value"></h4>
          </div>
        </div>
      </div>
    </template>

    <template id="actionButtonsTemplate">
      <div class="d-flex justify-content-center align-items-center gap-2 action-icons">
        <a class="btn btn-sm btn-outline-primary btn-edit" title="Edit">
          <i class="bi bi-pencil-square"></i>
        </a>
        <a class="btn btn-sm btn-outline-danger btn-delete" title="Delete">
          <i class="bi bi-trash"></i>
        </a>
      </div>
    </template>

</body>

<script>
  // function to get CSRF cookie
  function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      var cookies = document.cookie.split(';');
      $.each(cookies, function (i, cookie) {
        cookie = $.trim(cookie);
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          return false; // break loop
        }
      });
    }
    return cookieValue;
  }

  // jQuery global setup: adds CSRF to every non-GET request
  $.ajaxSetup({
    beforeSend: function (xhr, settings) {
      if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type)) {
        xhr.setRequestHeader("X-CSRFToken", getCookie("csrftoken"));
      }
    },
    complete: function (xhr) {
      if (xhr.responseJSON && xhr.responseJSON.status === 302) {
        // Session expired or forbidden
        showNotification("Session expired. Please log in again.", "danger");
        window.location.href = "/home/";
      }
    }
  });

  function populateAddModal(response) {
    const data = response.college_data;

    // Set header
    $("#modalCollegeName").text(data.College_Name);
    $("#modalCollegeAddress").text(data.address);

    // Clear existing fields
    $("#programSectionsContainer").empty();

    // Build program sections (empty)
    data.programs.forEach(program => {
      addProgramSection(program);
    });

    // Clear academic year selection
    $("#academicYear").val("");

    // Store college code for submission
    $("#collegeModal").data("college-code", data.College_Code);
  }


  function addProgramSection(programName) {

    const template = document.querySelector("#programTemplate");
    const clone = template.content.cloneNode(true);

    clone.querySelector(".program-title").innerText = programName;
    clone.querySelector(".program-section").dataset.program = programName;

    document.querySelector("#programSectionsContainer").appendChild(clone);
  }


  function validateProgramSection(section) {

    let programName = section.data("program");
    let total = parseInt(section.find(".total-students").val()) || 0;

    if (!total || total <= 0) {
      return {
        valid: false,
        message: `${programName}: Total Students is required and must be greater than 0.`
      };
    }

    function sumFields(selector) {
      let sum = 0;
      section.find(selector).each(function () {
        let val = parseInt($(this).val()) || 0;
        sum += val;
      });
      return sum;
    }

    // Calculate aggregates
    let genderSum = sumFields(".gender-male, .gender-female, .gender-others");
    let categorySum = sumFields(".cat-open, .cat-obc, .cat-sc, .cat-st, .cat-nt, .cat-vjnt, .cat-ews");
    let religionSum = sumFields(".rel-hindu, .rel-muslim, .rel-sikh, .rel-christian, .rel-jain, .rel-buddhist, .rel-other");
    let disabilitySum = sumFields(".dis-none, .dis-lowvision, .dis-blindness, .dis-hearing, .dis-locomotor, .dis-autism, .dis-other");

    // Validate each
    if (genderSum !== total) {
      return {
        valid: false,
        message: `${programName}: Gender total (${genderSum}) does not match Total Students (${total}).`
      };
    }
    if (categorySum !== total) {
      return {
        valid: false,
        message: `${programName}: Category total (${categorySum}) does not match Total Students (${total}).`
      };
    }
    if (religionSum !== total) {
      return {
        valid: false,
        message: `${programName}: Religion total (${religionSum}) does not match Total Students (${total}).`
      };
    }
    if (disabilitySum !== total) {
      return {
        valid: false,
        message: `${programName}: Disability total (${disabilitySum}) does not match Total Students (${total}).`
      };
    }

    return { valid: true };
  }


  function populateEditModal(response) {

    const data = response.college_data;
    const records = response.records;   // already structured per program

    $("#modalCollegeName").text(data.College_Name);
    $("#modalCollegeAddress").text(data.address);

    // Set academic year
    $("#academicYear").val(response.academic_year);

    $("#programSectionsContainer").empty();

    data.programs.forEach(programName => {
      addProgramSection(programName);

      // Fill values if they exist
      let section = $(`.program-section[data-program='${programName}']`);
      let saved = records[programName];

      if (!saved) return; // no record for this program

      section.find(".total-students").val(saved.total_students);

      section.find(".gender-male").val(saved.gender.male);
      section.find(".gender-female").val(saved.gender.female);
      section.find(".gender-others").val(saved.gender.others);

      section.find(".cat-open").val(saved.category.open);
      section.find(".cat-obc").val(saved.category.obc);
      section.find(".cat-sc").val(saved.category.sc);
      section.find(".cat-st").val(saved.category.st);
      section.find(".cat-nt").val(saved.category.nt);
      section.find(".cat-vjnt").val(saved.category.vjnt);
      section.find(".cat-ews").val(saved.category.ews);

      section.find(".rel-hindu").val(saved.religion.hindu);
      section.find(".rel-muslim").val(saved.religion.muslim);
      section.find(".rel-sikh").val(saved.religion.sikh);
      section.find(".rel-christian").val(saved.religion.christian);
      section.find(".rel-jain").val(saved.religion.jain);
      section.find(".rel-buddhist").val(saved.religion.buddhist);
      section.find(".rel-other").val(saved.religion.other);

      section.find(".dis-none").val(saved.disability.none);
      section.find(".dis-lowvision").val(saved.disability.lowvision);
      section.find(".dis-blindness").val(saved.disability.blindness);
      section.find(".dis-hearing").val(saved.disability.hearing);
      section.find(".dis-locomotor").val(saved.disability.locomotor);
      section.find(".dis-autism").val(saved.disability.autism);
      section.find(".dis-other").val(saved.disability.other);
    });

    // Store college code
    $("#collegeModal").data("college-code", data.College_Code);
  }


  $('document').ready(function () {

    $.ajax({
      url: "{% url 'user_status' %}", // backend endpoint for checking auth
      type: "GET",
      success: function (response) {
        if (response.status === 200) {
          // add datatable initialization
        } else {
          window.location.href = "/home/";
        }
      },
      error: function () {
        console.error("Auth check failed");
      }
    });


    // Toggle the cassette
    $("#AddRecordButton").on("click", function (e) {
      e.stopPropagation();
      $("#collegeCodeCassette").toggleClass("show");

      if ($("#collegeCodeCassette").hasClass("show")) {
        $("#collegeCodeInput").focus();
      }
    });

    // Click outside closes cassette
    $(document).on("click", function (e) {
      if (!$(e.target).closest("#collegeCodeCassette, #AddRecordButton").length) {
        $("#collegeCodeCassette").removeClass("show");
      }
    });

    // Prevent inner clicks from closing it
    $("#collegeCodeCassette").on("click", function (e) {
      e.stopPropagation();
    });

    // ADD MODE - When user enters college code to add new records
    $("#submitCollegeCode").on("click", function () {
      const collegeCode = $("#collegeCodeInput").val().trim();

      if (!collegeCode) {
        showNotification("Please enter a college code", "danger");
        return;
      }

      $.ajax({
        url: "/get-college-data/",
        type: "GET",
        data: {
          college_code: collegeCode,
          mode: "add"
        },
        success: function (response) {
          if (response.status === 200 && response.mode === "add") {
            populateAddModal(response);
            $("#collegeModal").data("mode", "add");
            $("#collegeModal").modal("show");
          }
          else if (response.status === 409) {
            showNotification(response.message, "danger");
          }
          else {
            showNotification("Invalid college code", "danger");
          }
        },
        error: function () {
          showNotification("Server error", "danger");
        }
      });
    });


    $("#submitRecordForm").on("click", function () {
      const collegeCode = $("#collegeModal").data("college-code");
      const academicYear = $("#academicYear").val();
      const mode = $("#collegeModal").data("mode");

      if (!academicYear) {
        showNotification("Please select academic year", "danger");
        return;
      }

      let records = {};
      let failedValidation = null;

      $(".program-section").each(function () {

        let section = $(this);

        // VALIDATE THIS PROGRAM FIRST
        let check = validateProgramSection(section);
        if (!check.valid) {
          failedValidation = check.message;
          return false; // stop loop
        }

        let program = section.data("program");

        records[program] = {

          total_students: section.find(".total-students").val(),

          gender: {
            male: section.find(".gender-male").val(),
            female: section.find(".gender-female").val(),
            others: section.find(".gender-others").val(),
          },

          category: {
            open: section.find(".cat-open").val(),
            obc: section.find(".cat-obc").val(),
            sc: section.find(".cat-sc").val(),
            st: section.find(".cat-st").val(),
            nt: section.find(".cat-nt").val(),
            vjnt: section.find(".cat-vjnt").val(),
            ews: section.find(".cat-ews").val(),
          },

          religion: {
            hindu: section.find(".rel-hindu").val(),
            muslim: section.find(".rel-muslim").val(),
            sikh: section.find(".rel-sikh").val(),
            christian: section.find(".rel-christian").val(),
            jain: section.find(".rel-jain").val(),
            buddhist: section.find(".rel-buddhist").val(),
            other: section.find(".rel-other").val(),
          },

          disability: {
            none: section.find(".dis-none").val(),
            lowvision: section.find(".dis-lowvision").val(),
            blindness: section.find(".dis-blindness").val(),
            hearing: section.find(".dis-hearing").val(),
            locomotor: section.find(".dis-locomotor").val(),
            autism: section.find(".dis-autism").val(),
            other: section.find(".dis-other").val(),
          }
        };
      });

      // IF ANY PROGRAM FAILED → STOP SUBMISSION
      if (failedValidation) {
        showNotification(failedValidation, "danger");
        return;
      }

      let payload = {
        college_code: collegeCode,
        academic_year: academicYear,
        records: records
      };

      if (mode === "add") {
        $.ajax({
          url: "/add_student/",
          type: "POST",
          data: JSON.stringify(payload),
          contentType: "application/json",
          success: function (response) {
            if (response.status === 200) {
              showNotification("Student records saved successfully!", "success");
              $("#collegeModal").modal("hide");
              table.ajax.reload(null, false);
            } else {
              showNotification(response.message || "Something went wrong", "danger");
            }
          },
          error: function () {
            showNotification("Server error", "danger");
          }
        });
      }
      else {
        // EDIT MODE
        $.ajax({
          url: "/edit_student/",
          type: "POST",
          data: JSON.stringify(payload),
          contentType: "application/json",
          success: function (response) {
            if (response.status === 200) {
              showNotification("Student records updated successfully!", "success");
              $("#collegeModal").modal("hide");
              table.ajax.reload(null, false);
            } else {
              showNotification(response.message || "Something went wrong", "danger");
            }
          },
          error: function () {
            showNotification("Server error", "danger");
          }
        });
      }
    });


    $("#logout_btn").on("click", function (e) {
      e.preventDefault();
      $.ajax({
        url: "{% url 'logout' %}",
        type: "POST",
        success: function (data) {
          if (data.status === 200) {
            window.location.href = "/home/";
          }
        },
        error: function () {
          alert("Logout failed. Try again.");
        }
      });
    });

    // Export Student Excel
    $(document).on("click", "#ExportStudentExcelButton", function () {
      const year = $("#globalAcademicYear").val();

      if (!year) {
        showNotification("Please select an academic year first", "danger");
        return;
      }

      // Direct download request
      window.location.href = "/export-student-excel/?year=" + encodeURIComponent(year);
    });

  })

  let selectedYear = $("#globalAcademicYear").val();

  const table = $("#records_table").DataTable({
    serverSide: true,
    processing: true,
    ajax: {
      url: "/get-student-records/",
      type: "GET",
      data: function (d) {
        d.year = selectedYear;
      }
    },
    pageLength: 10,
    columns: [
      {
        data: null,
        orderable: false,
        searchable: false,
        render: function () {
          return `
                        <button class="btn btn-sm btn-outline-primary toggle-programs">
                            <i class="bi bi-plus-lg"></i>
                        </button>`;
        }
      },
      { data: "college_code" },
      { data: "college_name" },
      { data: "academic_year" },
      {
        data: "total_students",
        render: (d) => d ?? "-"
      },
      {
        data: null,
        render: function (data, type, row) {
          const tpl = document.querySelector("#actionButtonsTemplate");
          const clone = tpl.content.cloneNode(true);

          // set edit attributes
          clone.querySelector(".btn-edit").setAttribute("data-college", row.college_code);
          clone.querySelector(".btn-edit").setAttribute("data-year", row.academic_year);

          // set delete handler
          clone.querySelector(".btn-delete").setAttribute("data-college", row.college_code);
          clone.querySelector(".btn-delete").setAttribute("data-year", row.academic_year);


          return $("<div>").append(clone).html();
        }
      }
    ],
    order: [[2, "asc"]]
  });

  //  YEAR CHANGE → RELOAD TABLE

  $("#globalAcademicYear").on("change", function () {
    selectedYear = $(this).val();
    table.ajax.reload();
  });

  //  BUILD FULL PROGRAM ACCORDION USING TEMPLATES

  function formatPrograms(row) {
    // wrapper will be returned as HTML string (DataTables expects HTML)
    const wrapper = document.createElement("div");
    wrapper.className = "dt-child-scroll";

    // Use container-fluid to offset the bootstrap row negative margins correctly
    const container = document.createElement("div");
    container.className = "container-fluid p-0";

    // small inner padding area so accordion header isn't flush to border
    const inner = document.createElement("div");
    inner.className = "px-3 py-3";

    // main accordion element
    const accordion = document.createElement("div");
    accordion.className = "accordion";
    accordion.id = `acc-${row.college_code}`;

    row.programs.forEach((p, i) => {
      // clone accordion-item template
      const tplItem = document.querySelector("#programAccordionTemplate");
      const acc = tplItem.content.cloneNode(true);

      // header button
      const btn = acc.querySelector(".accordion-button");
      btn.textContent = `${p.name} (${p.total_students} students)`;
      btn.setAttribute("data-bs-toggle", "collapse");
      btn.setAttribute("data-bs-target", `#collapse-${row.college_code}-${i}`);

      // collapse block and parent link
      const collapse = acc.querySelector(".accordion-collapse");
      collapse.id = `collapse-${row.college_code}-${i}`;
      collapse.setAttribute("data-bs-parent", `#acc-${row.college_code}`);

      // row container inside accordion body (already .row in template)
      const rowContainer = acc.querySelector(".program-content-row");

      // ---- TOTAL CARD ----
      const tplTotal = document.querySelector("#totalCardTemplate");
      const totalClone = tplTotal.content.cloneNode(true);
      totalClone.querySelector(".total-value").textContent = p.total_students;

      // Append total card to the row container
      rowContainer.appendChild(totalClone);

      // ---- METRICS GROUPS ----
      const metricGroups = {
        "Gender": { color: "bg-primary", data: p.gender },
        "Category": { color: "bg-success", data: p.category },
        "Religion": { color: "bg-warning text-dark", data: p.religion },
        "Disability": { color: "bg-danger", data: p.disability }
      };

      Object.entries(metricGroups).forEach(([title, meta]) => {
        const tplMetric = document.querySelector("#metricCardTemplate");
        const clone = tplMetric.content.cloneNode(true);

        // set title and color
        const titleEl = clone.querySelector(".metric-title");
        titleEl.textContent = title;
        titleEl.classList.add(...meta.color.split(" "));

        // fill table body rows
        const tbody = clone.querySelector(".metric-body");
        Object.entries(meta.data).forEach(([label, value]) => {
          const tr = document.createElement("tr");
          const td1 = document.createElement("td");
          const td2 = document.createElement("td");
          // capitalize first letter of label for display
          td1.textContent = label.charAt(0).toUpperCase() + label.slice(1);
          td2.textContent = value;
          tr.appendChild(td1);
          tr.appendChild(td2);
          tbody.appendChild(tr);
        });

        // ensure metric col uses flexible class so layout flows
        const metricCol = clone.querySelector(".metric-col");
        metricCol.classList.add("d-flex", "flex-column");

        rowContainer.appendChild(clone);
      });

      // append the built accordion-item clone
      accordion.appendChild(acc);
    });

    inner.appendChild(accordion);
    container.appendChild(inner);
    wrapper.appendChild(container);

    return wrapper.outerHTML;
  }



  //  EXPAND / COLLAPSE CHILD ROWS

  $("#records_table tbody").on("click", ".toggle-programs", function () {

    const tr = $(this).closest("tr");
    const row = table.row(tr);
    const btn = $(this);

    if (row.child.isShown()) {
      row.child.hide();
      btn.html('<i class="bi bi-plus-lg"></i>');
    } else {
      row.child(formatPrograms(row.data())).show();
      btn.html('<i class="bi bi-dash-lg"></i>');
    }
  });


  // EDIT MODE - When user clicks on "Edit"
  $(document).on("click", ".btn-edit", function () {
    const collegeCode = $(this).data("college");
    const academicYear = $(this).data("year");

    $.ajax({
      url: "/get-college-data/",
      type: "GET",
      data: {
        college_code: collegeCode,
        academic_year: academicYear,
        mode: "edit"
      },
      success: function (response) {
        if (response.status === 200 && response.mode === "edit") {
          populateEditModal(response);
          $("#collegeModal").modal("show");
          $("#collegeModal").data("mode", "edit");
        } else {
          showNotification(response.message || "Error loading record", "danger");
        }
      },
      error: function () {
        showNotification("Server error", "danger");
      }
    });
  });


  // DELETE RECORD HANDLER 
  $(document).on("click", ".btn-delete", function () {
    const college = $(this).data("college");
    console.log(college);
    const year = $(this).data("year");
    console.log(year);

    if (!college || !year) {
      showNotification("Invalid record selected.", "danger");
      return;
    }

    // Confirm deletion
    if (!confirm(`Delete records for ${college} (${year})?`)) {
      return;
    }

    $.ajax({
      url: "/delete-student-record/",
      type: "POST",
      data: {
        college_code: college,
        academic_year: year
      },
      success: function (response) {
        if (response.status === 204) {
          showNotification("Record deleted successfully.", "success");
          $("#records_table").DataTable().ajax.reload(null, false);
        } else {
          showNotification(response.message || "Delete failed", "danger");
        }
      },
      error: function () {
        showNotification("Server error", "danger");
      }
    });
  });



  function showNotification(message, type) {
    var notificationClass = type === "success" ? "notification-success" : "notification-error";
    var notification = $('<div>', {
      class: 'notification ' + notificationClass,
      text: message
    });

    $('body').append(notification);

    setTimeout(function () {
      notification.addClass('show-notification');
    }, 10); // slight delay to ensure the element is in the DOM

    setTimeout(function () {
      notification.removeClass('show-notification');
      setTimeout(function () {
        notification.remove();
      }, 500); // additional delay to allow transition effect
    }, 3000);
  }

</script>

</html>