<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Login</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- jQuery + Validation -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/jquery.validation/1.16.0/jquery.validate.min.js"></script>
  <script src="https://cdn.jsdelivr.net/jquery.validation/1.16.0/additional-methods.min.js"></script>

  <style>
    body {
      background: #f8f9fa;
    }

    .login-card {
      width: 380px;
      border-radius: 12px;
    }

    /* Notification Toast */
    .notification {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px 30px;
      background-color: #28a745;
      color: white;
      font-size: 1rem;
      font-weight: bold;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      opacity: 0;
      transition: opacity 0.5s ease-out, transform 0.5s ease-out;
      z-index: 2000;
    }

    .notification-success {
      background-color: #28a745;
    }

    .notification-error {
      background-color: #dc3545;
    }

    .show-notification {
      opacity: 1;
      transform: translateX(-50%) translateY(20px);
    }
  </style>
</head>

<body>

  <div class="container d-flex justify-content-center align-items-center" style="height: 100vh;">
    <div class="card shadow p-4 login-card">

      <h3 class="text-center mb-4">Login</h3>

      <form id="loginForm">
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

        <div class="mb-3">
          <label class="form-label">Email</label>
          <input type="email" name="email" class="form-control" required placeholder="Enter your email">
        </div>

        <div class="mb-3">
          <label class="form-label">Password</label>
          <input type="password" name="password" class="form-control" required minlength="6"
            placeholder="Enter password">
        </div>

        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="remember_me" name="remember_me" value="1">
          <label class="form-check-label">Remember me</label>
        </div>

        <button type="submit" class="btn btn-primary w-100">Login</button>

      </form>

    </div>
  </div>

  <script>
    // Notification function
    function showNotification(message, type) {
      var notificationClass = type === "success" ? "notification-success" : "notification-error";
      var notification = $('<div>', {
        class: 'notification ' + notificationClass,
        text: message
      });

      $('body').append(notification);

      setTimeout(function () {
        notification.addClass('show-notification');
      }, 10);

      setTimeout(function () {
        notification.removeClass('show-notification');
        setTimeout(function () {
          notification.remove();
        }, 500);
      }, 3000);
    }

    // function to get CSRF cookie
    function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        $.each(cookies, function (i, cookie) {
          cookie = $.trim(cookie);
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            return false; // break loop
          }
        });
      }
      return cookieValue;
    }

    // jQuery global setup: adds CSRF to every non-GET request
    $.ajaxSetup({
      beforeSend: function (xhr, settings) {
        if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type)) {
          xhr.setRequestHeader("X-CSRFToken", getCookie("csrftoken"));
        }
      },
      complete: function (xhr) {
        if (xhr.responseJSON && xhr.responseJSON.status === 302) {
          // Session expired or forbidden
          showNotification("Session expired. Please log in again.", "danger")
        }
      }
    });

    // Submit form
    $("#loginForm").submit(function (e) {
      e.preventDefault();

      $.ajax({
        url: "/login/",
        type: "POST",
        data: $("#loginForm").serialize(),
        success: function (res) {
          if (res.status === 200) {
            showNotification(res.message, "success");
            setTimeout(() => window.location.href = "/", 500);
          } else {
            showNotification(res.message, "error");
          }
        },
        error: function () {
          showNotification("Something went wrong", "error");
        }
      });
    });
  </script>

</body>

</html>